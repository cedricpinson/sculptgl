function Aabb(){this.min_=[Infinity,Infinity,Infinity];this.max_=[-Infinity,-Infinity,-Infinity];this.center_=[0,0,0]}
Aabb.prototype={clone:function(){var a=new Aabb;vec3.copy(a.min_,this.min_);vec3.copy(a.max_,this.max_);vec3.copy(a.center_,this.center_);return a},copy:function(a){vec3.copy(this.min_,a.min_);vec3.copy(this.max_,a.max_);return this},setCopy:function(a,b){vec3.copy(this.min_,a);vec3.copy(this.max_,b);return this},set:function(a,b,c,d,e,g){var k=this.min_,f=this.max_;k[0]=a;k[1]=b;k[2]=c;f[0]=d;f[1]=e;f[2]=g;return this},computeCenter:function(){var a=[0,0,0];return vec3.scale(a,vec3.add(a,this.min_,
this.max_),0.5)},isOutside:function(a){var b=this.min_,c=this.max_,d=a.min_;a=a.max_;return d[0]>c[0]||a[0]<b[0]||d[1]>c[1]||a[1]<b[1]||d[2]>c[2]||a[2]<b[2]?!0:!1},isInside:function(a){var b=this.min_,c=this.max_,d=a.min_;a=a.max_;return b[0]>=d[0]&&c[0]<=a[0]&&b[1]>=d[1]&&c[1]<=a[1]&&b[2]>=d[2]&&c[2]<=a[2]?!0:!1},pointInside:function(a){var b=this.min_,c=this.max_,d=a[0],e=a[1];a=a[2];return d<=b[0]||d>c[0]||e<=b[1]||e>c[1]||a<=b[2]||a>c[2]?!1:!0},expandsWithPoint:function(a,b,c){var d=this.min_,
e=this.max_;a>e[0]&&(e[0]=a);a<d[0]&&(d[0]=a);b>e[1]&&(e[1]=b);b<d[1]&&(d[1]=b);c>e[2]&&(e[2]=c);c<d[2]&&(d[2]=c)},expandsWithAabb:function(a){var b=this.min_,c=this.max_,d=a.min_,e=a.max_;a=d[0];var g=d[1],d=d[2],k=e[0],f=e[1],e=e[2];k>c[0]&&(c[0]=k);a<b[0]&&(b[0]=a);f>c[1]&&(c[1]=f);g<b[1]&&(b[1]=g);e>c[2]&&(c[2]=e);d<b[2]&&(b[2]=d)},intersectRay:function(a,b){var c=this.min_,d=this.max_,e=b[0],g=b[1],k=b[2],f=a[0],h=a[1],l=a[2],m=(c[0]-f)*e,e=(d[0]-f)*e,f=(c[1]-h)*g,g=(d[1]-h)*g,c=(c[2]-l)*k,k=
(d[2]-l)*k,d=Math.max(Math.max(Math.min(m,e),Math.min(f,g)),Math.min(c,k)),m=Math.min(Math.min(Math.max(m,e),Math.max(f,g)),Math.max(c,k));return 0<=m&&d<m},intersectSphere:function(a,b){var c=this.min_,d=this.max_,e=a[0],g=a[1],k=a[2],f=0,h=0,l=0,f=c[0]>e?c[0]-e:d[0]<e?d[0]-e:0,h=c[1]>g?c[1]-g:d[1]<g?d[1]-g:0,l=c[2]>k?c[2]-k:d[2]<k?d[2]-k:0;return f*f+h*h+l*l<b},enlargeIfFlat:function(a){var b=this.min_,c=this.max_;b[0]===c[0]&&(b[0]-=a,c[0]+=a);b[1]===c[1]&&(b[1]-=a,c[1]+=a);b[2]===c[2]&&(b[2]-=
a,c[2]+=a)},intersectPlane:function(a,b){var c=this.computeCenter(),c=vec3.dot(vec3.sub(c,c,a),b);return c*c<0.25*vec3.sqrDist(this.min_,this.max_)?2:0<c?1:0}};function Camera(){this.mode_=Camera.mode.PLANE;this.type_=Camera.projType.PERSPECTIVE;this.rot_=quat.create();this.view_=mat4.create();this.proj_=mat4.create();this.lastNormalizedMouseXY_=[0,0];this.transY_=this.transX_=this.zoom_=this.height_=this.width_=0;this.speed_=1;this.moveZ_=this.moveX_=0;this.fov_=45;this.center_=[0,0,0];this.stepCenter_=[0,0,0];this.stepCount_=this.stepZoom_=0;this.usePivot_=!1}Camera.mode={SPHERICAL:0,PLANE:1};Camera.projType={PERSPECTIVE:0,ORTHOGRAPHIC:1};
Camera.prototype={start:function(a,b,c){this.lastNormalizedMouseXY_=Geometry.normalizedMouse(a,b,this.width_,this.height_);this.usePivot_&&c.mesh_&&(this.stepCount_=10,vec3.transformMat4(this.stepCenter_,c.interPoint_,c.mesh_.matTransform_),a=vec3.dist(this.stepCenter_,this.computePosition()),this.stepZoom_=this.type_===Camera.projType.PERSPECTIVE?(a-this.zoom_)/this.stepCount_:0,this.speed_=5*a,vec3.sub(this.stepCenter_,this.stepCenter_,this.center_),vec3.scale(this.stepCenter_,this.stepCenter_,
1/this.stepCount_))},rotate:function(a,b){var c=Geometry.normalizedMouse(a,b,this.width_,this.height_);if(this.mode_===Camera.mode.PLANE){var d=vec2.dist(this.lastNormalizedMouseXY_,c),e=[0,0];vec2.sub(e,c,this.lastNormalizedMouseXY_);e=[-e[1],e[0],0];vec3.normalize(e,e);quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],e,2*d),this.rot_)}else if(this.mode_===Camera.mode.SPHERICAL){var d=Geometry.mouseOnUnitSphere(this.lastNormalizedMouseXY_),e=Geometry.mouseOnUnitSphere(c),g=Math.acos(Math.min(1,vec3.dot(d,
e))),k=[0,0,0];vec3.normalize(k,vec3.cross(k,d,e));quat.mul(this.rot_,quat.setAxisAngle([0,0,0,0],k,2*g),this.rot_)}0<this.stepCount_&&(--this.stepCount_,this.zoom_+=this.stepZoom_,vec3.add(this.center_,this.center_,this.stepCenter_));this.lastNormalizedMouseXY_=c},updateView:function(){var a=this.view_,b=this.transX_,c=this.transY_;this.type_===Camera.projType.PERSPECTIVE?mat4.lookAt(a,[b,c,this.zoom_],[b,c,0],[0,1,0]):mat4.lookAt(a,[b,c,1E3],[b,c,0],[0,1,0]);mat4.mul(a,a,mat4.fromQuat(mat4.create(),
this.rot_));b=this.center_;mat4.translate(a,a,[-b[0],-b[1],-b[2]])},updateProjection:function(){this.proj_=mat4.create();this.type_===Camera.projType.PERSPECTIVE?mat4.perspective(this.proj_,this.fov_*Math.PI/180,this.width_/this.height_,0.05,5E3):this.updateOrtho()},updateTranslation:function(){this.transX_+=this.moveX_*this.speed_/400;this.zoom_=Math.max(1E-5,this.zoom_+this.moveZ_*this.speed_/400);this.type_===Camera.projType.ORTHOGRAPHIC&&this.updateOrtho()},translate:function(a,b){this.transX_-=
a*this.speed_;this.transY_+=b*this.speed_},zoom:function(a){this.zoom_=Math.max(1E-5,this.zoom_-a*this.speed_);this.type_===Camera.projType.ORTHOGRAPHIC&&this.updateOrtho()},updateOrtho:function(){var a=5.5E-4*Math.abs(this.zoom_);mat4.ortho(this.proj_,-this.width_*a,this.width_*a,-this.height_*a,this.height_*a,-1E4,1E4)},computePosition:function(){var a=this.view_,b=[-a[12],-a[13],-a[14]],c=mat3.create();mat3.fromMat4(c,a);return vec3.transformMat3(b,b,mat3.transpose(c,c))},toggleUsePivot:function(){this.transY_=
this.transX_=0},reset:function(){this.transY_=this.transX_=0;this.speed_=1.4*Mesh.globalScale_;this.rot_=quat.create();this.center_=[0,0,0];this.zoom_=0;this.zoom(-0.6)},resetViewFront:function(){this.rot_=quat.create()},resetViewTop:function(){this.rot_=quat.rotateX(this.rot_,quat.create(),0.5*Math.PI)},resetViewLeft:function(){this.rot_=quat.rotateY(this.rot_,quat.create(),0.5*-Math.PI)},unproject:function(a,b,c){var d=this.height_;a=[2*a/this.width_-1,(d-2*b)/d,2*c-1,1];b=mat4.create();vec4.transformMat4(a,
a,mat4.invert(b,mat4.mul(b,this.proj_,this.view_)));b=a[3];return[a[0]/b,a[1]/b,a[2]/b]},project:function(a){a=[a[0],a[1],a[2],1];vec4.transformMat4(a,a,this.view_);vec4.transformMat4(a,a,this.proj_);var b=a[3],c=this.height_;return[0.5*(a[0]/b+1)*this.width_,c-0.5*(a[1]/b+1)*c,0.5*(a[2]/b+1)]}};var Import={importOBJ:function(a,b){for(var c=b.vertices_,d=b.triangles_,e=[],g=[],k=a.split("\n"),f=[],h=k.length,l=0;l<h;++l){var m=k[l].trim();if(m.startsWith("v "))f=m.split(/\s+/),c.push(new Vertex(c.length)),e.push(parseFloat(f[1]),parseFloat(f[2]),parseFloat(f[3]));else if(m.startsWith("f ")){var f=m.split(/\s+/),m=f[1].split("/"),n=f[2].split("/"),p=f[3].split("/"),m=parseInt(m[0],10),q=parseInt(n[0],10),p=parseInt(p[0],10),r=c.length;0>m?(m+=r,q+=r,p+=r):(--m,--q,--p);var n=c[m],s=c[q],u=
c[p],v=d.length;n.tIndices_.push(v);s.tIndices_.push(v);u.tIndices_.push(v);d.push(new Triangle(v));g.push(m,q,p);4<f.length&&(++v,f=parseInt(f[4].split("/")[0],10),0>f?f+=r:--f,q=c[f],n.tIndices_.push(v),u.tIndices_.push(v),q.tIndices_.push(v),d.push(new Triangle(v)),g.push(m,p,f))}}Import.initMeshArrays(b,e,g)},importPLY:function(a,b){for(var c=b.vertices_,d=b.triangles_,e=[],g=[],k=[],f=a.split("\n"),h=[],l=-1,m=-1,n=-1,p=0,q=1/255;;){h=f[p].trim();if(h.startsWith("element vertex ")){for(var h=
h.split(/\s+/),l=parseInt(h[2],10),r=p;;)if(++p,h=f[p].trim(),h.startsWith("property ")){if(h=h.split(/\s+/),"red"===h[2]){n=p-r-1;break}}else break;--p}else if(h.startsWith("element face "))h=h.split(/\s+/),m=parseInt(h[2],10);else if(h.startsWith("end_header")){++p;for(l+=p;p<l;++p)h=f[p].trim(),h=h.split(/\s+/),c.push(new Vertex(c.length)),e.push(parseFloat(h[0]),parseFloat(h[1]),parseFloat(h[2])),g.push(parseInt(h[n],10)*q,parseInt(h[n+1],10)*q,parseInt(h[n+2],10)*q);for(m+=p;p<m;++p){var h=f[p].trim(),
h=h.split(/\s+/),s=parseInt(h[0],10);if(3===s||4===s){var n=parseInt(h[1],10),u=parseInt(h[2],10),q=parseInt(h[3],10),l=c[n],v=c[u],r=c[q],w=d.length;l.tIndices_.push(w);v.tIndices_.push(w);r.tIndices_.push(w);d.push(new Triangle(w));k.push(n,u,q);4===s&&(++w,h=parseInt(h[4],10),s=c[h],l.tIndices_.push(w),r.tIndices_.push(w),s.tIndices_.push(w),d.push(new Triangle(w)),k.push(n,q,h))}}break}++p}Import.initMeshArrays(b,e,k,g)},importSTL:function(a,b){84+50*Import.getUint32(a,80)===a.length?Import.importBinarySTL(a,
b):Import.importAsciiSTL(a,b)},importAsciiSTL:function(a,b){for(var c=b.vertices_,d=b.triangles_,e=[],g=[],k=a.split("\n"),f=[],h=k.length,l={},m=0,n=0,p=f=0,q=0,r=m=0,s=0;s<h;++s)k[s].trim().startsWith("facet")&&(r=d.length,f=k[s+2].trim().split(/\s+/),m=parseFloat(f[1]),n=parseFloat(f[2]),f=parseFloat(f[3]),p=Import.detectNewVertex(l,m,n,f,c,e,r),f=k[s+3].trim().split(/\s+/),m=parseFloat(f[1]),n=parseFloat(f[2]),f=parseFloat(f[3]),q=Import.detectNewVertex(l,m,n,f,c,e,r),f=k[s+4].trim().split(/\s+/),
m=parseFloat(f[1]),n=parseFloat(f[2]),f=parseFloat(f[3]),m=Import.detectNewVertex(l,m,n,f,c,e,r),g.push(p,q,m),d.push(new Triangle(r)),s+=6);Import.initMeshArrays(b,e,g)},importBinarySTL:function(a,b){for(var c=b.vertices_,d=b.triangles_,e=[],g=[],k=Import.getUint32(a,80),f={},h=0,l=0,m=0,n=0,p=0,h=0,q=96,r=0,s=0;s<k;++s)r=d.length,h=Import.getFloat32(a,q),l=Import.getFloat32(a,q+4),m=Import.getFloat32(a,q+8),n=Import.detectNewVertex(f,h,l,m,c,e,r),h=Import.getFloat32(a,q+12),l=Import.getFloat32(a,
q+16),m=Import.getFloat32(a,q+20),p=Import.detectNewVertex(f,h,l,m,c,e,r),h=Import.getFloat32(a,q+24),l=Import.getFloat32(a,q+28),m=Import.getFloat32(a,q+32),h=Import.detectNewVertex(f,h,l,m,c,e,r),g.push(n,p,h),d.push(new Triangle(r)),q+=50;Import.initMeshArrays(b,e,g)},detectNewVertex:function(a,b,c,d,e,g,k){var f=b+"+"+c+"+"+d,h=a[f];void 0===h&&(h=e.length,e.push(new Vertex(h)),g.push(b,c,d),a[f]=h);e[h].tIndices_.push(k);return h},initMeshArrays:function(a,b,c,d){a.vertexArray_=new Float32Array(2*
b.length);a.normalArray_=new Float32Array(2*b.length);a.colorArray_=new Float32Array(2*b.length);a.indexArray_=new SculptGL.indexArrayType(2*c.length);a.vertexArray_.set(b);a.indexArray_.set(c);if(d)a.colorArray_.set(d);else{b=b.length/3;a=a.colorArray_;for(d=c=0;d<b;++d)c=3*d,a[c]=0.53,a[c+1]=0.3,a[c+2]=0.3}},getBytes:function(a,b){return[a[b].charCodeAt(),a[b+1].charCodeAt(),a[b+2].charCodeAt(),a[b+3].charCodeAt()]},getUint32:function(a,b){var c=Import.getBytes(a,b);return c[0]<<0|c[1]<<8|c[2]<<
16|c[3]<<24},getFloat32:function(a,b){var c=Import.getBytes(a,b),d=1-2*(c[3]>>7),e=(c[3]<<1&255|c[2]>>7)-127,c=(c[2]&127)<<16|c[1]<<8|c[0];return 128===e?0!==c?NaN:Infinity*d:-127===e?d*c*Math.pow(2,-149):d*(1+c*Math.pow(2,-23))*Math.pow(2,e)}};var Export={exportOBJ:function(a,b){var c=a.vertexArray_,d=a.colorArray_,e=a.indexArray_,g="s 0\n";b&&(g=g+("mtllib "+b+".mtl\n")+("usemtl "+b+"\n"));for(var k=a.vertices_.length,f=a.triangles_.length,h=1/a.scale_,l=0,m=0,l=0;l<k;++l)m=3*l,g=b?g+("v "+c[m]*h+" "+c[m+1]*h+" "+c[m+2]*h+d[m]+" "+d[m+1]+" "+d[m+2]+"\n"):g+("v "+c[m]*h+" "+c[m+1]*h+" "+c[m+2]*h+"\n");for(l=0;l<f;++l)m=3*l,g+="f "+(1+e[m])+" "+(1+e[m+1])+" "+(1+e[m+2])+"\n";return g},exportSTL:function(a){return Export.exportAsciiSTL(a)},
exportAsciiSTL:function(a){var b=a.vertexArray_,c=a.indexArray_,d="solid mesh\n",e=a.triangles_,g=e.length;a=1/a.scale_;for(var k=0,f=0,k=0;k<g;++k)var f=3*k,h=e[k].normal_,d=d+(" facet normal "+h[0]+" "+h[1]+" "+h[2]+"\n"),d=d+"  outer loop\n",h=3*c[f],l=3*c[f+1],f=3*c[f+2],d=d+("   vertex "+b[h]*a+" "+b[h+1]*a+" "+b[h+2]*a+"\n"),d=d+("   vertex "+b[l]*a+" "+b[l+1]*a+" "+b[l+2]*a+"\n"),d=d+("   vertex "+b[f]*a+" "+b[f+1]*a+" "+b[f+2]*a+"\n"),d=d+"  endloop\n",d=d+" endfacet\n";return d+"endsolid mesh\n"},
exportPLY:function(a){return Export.exportAsciiPLY(a)},exportAsciiPLY:function(a){var b=a.vertexArray_,c=a.colorArray_,d=a.indexArray_,e=a.vertices_.length,g=a.triangles_.length,k=1/a.scale_,f=0,h=0;a="ply\nformat ascii 1.0\ncomment created by SculptGL\n"+("element vertex "+e+"\n")+"property float x\nproperty float y\nproperty float z\n";a+="property uchar red\nproperty uchar green\nproperty uchar blue\n";a+="element face "+g+"\n";a+="property list uchar uint vertex_indices\nend_header\n";for(f=0;f<
e;++f)h=3*f,a+=b[h]*k+" "+b[h+1]*k+" "+b[h+2]*k+" "+(255*c[h]|0)+" "+(255*c[h+1]|0)+" "+(255*c[h+2]|0)+"\n";for(f=0;f<g;++f)h=3*f,a+="3 "+d[h]+" "+d[h+1]+" "+d[h+2]+"\n";return a},exportSpecularMtl:function(){var a;a="newmtl specular\nKs 1.0 1.0 1.0\nNs 200.0\n";return a+="d 1.0\n"},exportSketchfab:function(a){a=Export.exportOBJ(a,"specular");var b=Export.exportSpecularMtl(),c=new JSZip;c.file("model.obj",a);c.file("specular.mtl",b);a={fileModel:c.generate({type:"blob",compression:"DEFLATE"}),filenameModel:"model.zip",
title:""};Sketchfab.showUploader(a)}};var Geometry={normalizedMouse:function(a,b,c,d){return[2*a/c-1,1-2*b/d]},mouseOnUnitSphere:function(a){var b=a[0];a=a[1];var c=1-b*b-a*a,c=0<c?Math.sqrt(c):0,b=[b,a,c];return vec3.normalize(b,b)}};
Geometry.intersectionRayTriangle=function(){var a=[0,0,0],b=[0,0,0],c=[0,0,0],d=[0,0,0],e=[0,0,0];return function(g,k,f,h,l,m){vec3.sub(a,h,f);vec3.sub(b,l,f);vec3.cross(c,k,b);h=vec3.dot(a,c);if(-1E-20<h&&1E-20>h)return!1;h=1/h;vec3.sub(d,g,f);f=vec3.dot(d,c)*h;if(0>f||1<f)return!1;vec3.cross(e,d,a);l=vec3.dot(k,e)*h;if(0>l||1<f+l)return!1;f=vec3.dot(b,e)*h;if(0>f)return!1;vec3.scaleAndAdd(m,g,k,f);return!0}}();
Geometry.computeTriangleAabb=function(a,b,c,d,e,g,k,f,h,l){var m=a.min_,n=a.max_;a=a.center_;m[0]=Math.min(b,e,f);m[1]=Math.min(c,g,h);m[2]=Math.min(d,k,l);n[0]=Math.max(b,e,f);n[1]=Math.max(c,g,h);n[2]=Math.max(d,k,l);a[0]=0.5*(m[0]+n[0]);a[1]=0.5*(m[1]+n[1]);a[2]=0.5*(m[2]+n[2])};Geometry.triangleNormal=function(a,b,c,d,e,g,k,f,h,l){e-=b;g-=c;k-=d;b=f-b;c=h-c;l-=d;d=g*l-k*c;l=k*b-e*l;e=e*c-g*b;g=d*d+l*l+e*e;0!==g&&(g=1/Math.sqrt(g),a[0]=d*g,a[1]=l*g,a[2]=e*g)};
Geometry.pointInsideTriangle=function(){var a=[0,0,0],b=[0,0,0],c=[0,0,0],d=[0,0,0],e=[0,0,0];return function(g,k,f,h){vec3.sub(a,k,f);vec3.sub(b,k,h);vec3.sub(c,g,f);vec3.sub(d,g,h);g=vec3.len(vec3.cross(e,a,b));k=vec3.len(vec3.cross(e,a,c));f=vec3.len(vec3.cross(e,b,d));h=vec3.len(vec3.cross(e,c,d));return 1E-20>Math.abs(g-(k+f+h))}}();
Geometry.triangleInsideSphere=function(a,b,c,d,e){return Geometry.distanceSqToSegment(a,c,d)<b||Geometry.distanceSqToSegment(a,d,e)<b||Geometry.distanceSqToSegment(a,c,e)<b?!0:!1};Geometry.distanceSqToSegment=function(){var a=[0,0,0],b=[0,0,0];return function(c,d,e){vec3.sub(a,c,d);vec3.sub(b,e,d);var g=vec3.sqrLen(b),g=vec3.dot(a,b)/g;if(0>g)return vec3.sqrLen(a);if(1<g)return vec3.sqrLen(vec3.sub(a,c,e));a[0]=c[0]-d[0]-g*b[0];a[1]=c[1]-d[1]-g*b[1];a[2]=c[2]-d[2]-g*b[2];return vec3.sqrLen(a)}}();
Geometry.signedAngle2d=function(a,b){var c=a[0],d=a[1],e=b[0],g=b[1];return Math.atan2(c*g-d*e,c*e+d*g)};Geometry.pointPlaneDistance=function(){var a=[0,0,0];return function(b,c,d){return vec3.dot(vec3.sub(a,b,c),d)}}();Geometry.mirrorPoint=function(){var a=[0,0,0];return function(b,c,d){return vec3.sub(b,b,vec3.scale(a,d,2*Geometry.pointPlaneDistance(b,c,d)))}}();
Geometry.vertexOnLine=function(){var a=[0,0,0];return function(b,c,d){vec3.sub(a,d,c);d=[0,0,0];b=vec3.dot(a,vec3.sub(d,b,c));return vec3.scaleAndAdd(d,c,a,b/vec3.sqrLen(a))}}();Geometry.intersectLinePlane=function(a,b,c,d,e){var g=vec3.dot(vec3.sub(e,a,c),d);c=vec3.dot(vec3.sub(e,b,c),d);return g===c?b:vec3.scaleAndAdd(e,a,vec3.sub(e,b,a),-g/(c-g))};
Geometry.getPerpendicularVector=function(a){var b=[0,0,0];0===a[0]?b[0]=1:0===a[1]?b[1]=1:0===a[2]?b[2]=1:(b[0]=a[2],b[1]=a[2],b[2]=-a[0]-a[1],vec3.normalize(b,b));return b};function Grid(){this.aabb_=new Aabb;this.size_=this.cellSize_=this.dimZ_=this.dimY_=this.dimX_=0;this.iVerts_=[]}
Grid.prototype={setBoundaries:function(a){var b=[0,0,0];vec3.sub(b,a.max_,a.min_);vec3.scale(b,b,0.1);vec3.sub(a.min_,a.min_,b);vec3.add(a.max_,a.max_,b);this.aabb_=a},init:function(a){this.cellSize_=a;var b=this.aabb_,c=[0,0,0];vec3.sub(c,b.max_,b.min_);var b=Math.ceil(c[0]/a),d=Math.ceil(c[1]/a);a=Math.ceil(c[2]/a);0>=b&&(b=1);0>=d&&(d=1);0>=a&&(a=1);var c=this.size_=1+b*d*a,e=this.iVerts_;e.length=c;for(var g=0;g<c;++g)e[g]=[];this.dimX_=b;this.dimY_=d;this.dimZ_=a},build:function(a,b){for(var c=
a.vertexArray_,d=this.aabb_.min_,e=this.dimX_,g=e*this.dimY_,k=0,f=0,h=0,l=0,h=0,m=this.cellSize_,n=this.size_,p=this.iVerts_,q=b.length,l=0;l<q;++l){var r=b[l],h=3*r,k=Math.floor((c[h]-d[0])/m),f=Math.floor((c[h+1]-d[1])/m),h=Math.floor((c[h+2]-d[2])/m),k=k+f*e+h*g;0>k?k=0:k>=n&&(k=n-1);p[k].push(r)}},getNeighborhood:function(a,b,c){var d=this.aabb_.min_,e=this.cellSize_,g=this.dimX_,k=this.dimY_,f=this.dimZ_,h=g*this.dimY_;a=Math.floor((a-d[0])/e);b=Math.floor((b-d[1])/e);c=Math.floor((c-d[2])/
e);0>a?a=0:a>=g&&(a=g-1);0>b?b=0:b>=k&&(b=k-1);0>c?c=0:c>=f&&(c=f-1);var l=e=d=-1,m=1,n=1,p=1;0>=a&&(d=0);a>=g-1&&(m=0);0>=b&&(e=0);b>=k-1&&(n=0);0>=c&&(l=0);c>=f-1&&(p=0);for(var q=f=k=0,r=this.iVerts_,s=[],k=d;k<=m;++k)for(f=e;f<=n;++f)for(q=l;q<=p;++q)s.push.apply(s,r[a+k+(b+f)*g+(c+q)*h]);return s}};function Mesh(a){this.vertices_=[];this.triangles_=[];this.indexArray_=this.colorArray_=this.normalArray_=this.vertexArray_=null;this.center_=[0,0,0];this.octree_=new Octree;this.matTransform_=mat4.create();this.leavesUpdate_=[];this.render_=new Render(a,this);this.scale_=1;this.queued_=!1}Mesh.globalScale_=500;Mesh.stateMask_=1;
Mesh.prototype={getTrianglesFromVertices:function(a){for(var b=++Triangle.tagMask_,c=[],d=a.length,e=this.vertices_,g=this.triangles_,k=0;k<d;++k)for(var f=e[a[k]].tIndices_,h=f.length,l=0;l<h;++l){var m=f[l];g[m].tagFlag_!==b&&(c.push(m),g[m].tagFlag_=b)}return c},getVerticesFromTriangles:function(a){for(var b=++Vertex.tagMask_,c=[],d=a.length,e=this.vertices_,g=this.indexArray_,k=0;k<d;++k){var f=3*a[k],h=g[f],l=g[f+1],f=g[f+2];e[h].tagFlag_!==b&&(c.push(h),e[h].tagFlag_=b);e[l].tagFlag_!==b&&(c.push(l),
e[l].tagFlag_=b);e[f].tagFlag_!==b&&(c.push(f),e[f].tagFlag_=b)}return c},expandsTriangles:function(a,b){for(var c=++Triangle.tagMask_,d=a.length,e=this.vertices_,g=this.triangles_,k=this.indexArray_,f=0,h=0,f=0;f<d;++f)g[a[f]].tagFlag_=c;for(f=0;b;){for(--b;f<d;++f){for(var h=3*a[f],l=e[k[h]].tIndices_,m=e[k[h+1]].tIndices_,n=e[k[h+2]].tIndices_,p=l.length,q=m.length,r=n.length,h=0;h<p;++h){var s=g[l[h]];s.tagFlag_!==c&&(s.tagFlag_=c,a.push(l[h]))}for(h=0;h<q;++h)l=g[m[h]],l.tagFlag_!==c&&(l.tagFlag_=
c,a.push(m[h]));for(h=0;h<r;++h)m=g[n[h]],m.tagFlag_!==c&&(m.tagFlag_=c,a.push(n[h]))}f=d;d=a.length}},expandsVertices:function(a,b){for(var c=++Vertex.tagMask_,d=a.length,e=this.vertices_,g=0,k=0,g=0;g<d;++g)e[a[g]].tagFlag_=c;for(g=0;b;){for(--b;g<d;++g)for(var f=e[a[g]].ringVertices_,h=f.length,k=0;k<h;++k){var l=e[f[k]];l.tagFlag_!==c&&(l.tagFlag_=c,a.push(f[k]))}g=d;d=a.length}},computeRingVertices:function(a){var b=++Vertex.tagMask_,c=this.vertices_,d=this.indexArray_,e=c[a];e.ringVertices_.length=
0;for(var g=e.ringVertices_,e=e.tIndices_,k=e.length,f=0;f<k;++f){var h=3*e[f],l=d[h],m=d[h+1],h=d[h+2];l!==a&&c[l].tagFlag_!==b&&(g.push(l),c[l].tagFlag_=b);m!==a&&c[m].tagFlag_!==b&&(g.push(m),c[m].tagFlag_=b);h!==a&&c[h].tagFlag_!==b&&(g.push(h),c[h].tagFlag_=b)}},moveTo:function(a){mat4.translate(this.matTransform_,mat4.create(),vec3.sub(a,a,this.center_))},render:function(a,b,c,d){this.render_.render(a,b,c,d)},initMesh:function(){for(var a=this.vertexArray_,b=this.vertices_.length,c=new Aabb,
d=0,e=0,d=0;d<b;++d)this.computeRingVertices(d),e=3*d,c.expandsWithPoint(a[e],a[e+1],a[e+2]);this.center_=c.computeCenter();for(var d=vec3.dist(c.min_,c.max_),g=this.scale_=Mesh.globalScale_/d,d=0;d<b;++d)e=3*d,a[e]*=g,a[e+1]*=g,a[e+2]*=g;mat4.scale(this.matTransform_,this.matTransform_,[g,g,g]);vec3.scale(c.min_,c.min_,g);vec3.scale(c.max_,c.max_,g);vec3.scale(this.center_,this.center_,g);a=[0,0,0];vec3.sub(a,c.max_,c.min_);vec3.scale(a,a,0.2);vec3.sub(c.min_,c.min_,a);vec3.add(c.max_,c.max_,a);
c.enlargeIfFlat(vec3.length(a));this.updateTrianglesAabbAndNormal();this.updateVerticesNormal();this.computeOctree(c)},computeOctree:function(a){for(var b=this.triangles_.length,c=[],d=0;d<b;++d)c.push(d);this.octree_=new Octree;this.octree_.aabbSplit_.copy(a);this.octree_.build(this,c)},initRender:function(a,b,c){this.render_.initBuffers();this.render_.updateShaders(a,b,c);this.render_.updateBuffers()},doUpdateBuffers:function(){this.render_.updateBuffers();this.queued_=!1},updateBuffers:function(){this.queued_=
!0},updateMesh:function(a,b){this.updateTrianglesAabbAndNormal(a);this.updateOctree(a);this.updateVerticesNormal(b)},updateTrianglesAabbAndNormal:function(a){for(var b=this.triangles_,c=this.vertexArray_,d=this.indexArray_,e=void 0!==a,g=e?a.length:b.length,k=0;k<g;++k){var f=e?a[k]:k,h=b[f],f=3*f,l=3*d[f],m=3*d[f+1],n=3*d[f+2],f=c[l],p=c[l+1],l=c[l+2],q=c[m],r=c[m+1],m=c[m+2],s=c[n],u=c[n+1],n=c[n+2];Geometry.triangleNormal(h.normal_,f,p,l,q,r,m,s,u,n);Geometry.computeTriangleAabb(h.aabb_,f,p,l,
q,r,m,s,u,n)}},updateVerticesNormal:function(a){for(var b=this.vertices_,c=this.triangles_,d=this.normalArray_,e=void 0!==a,g=e?a.length:b.length,k=0;k<g;++k){for(var f=e?a[k]:k,h=b[f].tIndices_,l=h.length,m=0,n=0,p=0,q=0;q<l;++q)var r=c[h[q]].normal_,m=m+r[0],n=n+r[1],p=p+r[2];h=1/Math.sqrt(m*m+n*n+p*p);f*=3;d[f]=m*h;d[f+1]=n*h;d[f+2]=p*h}},updateOctree:function(a){for(var b=a.length,c=[],d=this.triangles_,e=0,g,e=0;e<b;++e){var k=d[a[e]];g=k.leaf_;if(g.aabbSplit_.pointInside(k.aabb_.center_))k.aabb_.isInside(g.aabbLoose_)||
g.aabbLoose_.expandsWithAabb(k.aabb_);else if(c.push(a[e]),g=g.iTris_,0<g.length){var f=g[g.length-1],k=k.posInLeaf_;g[k]=f;d[f].posInLeaf_=k;g.pop()}}a=c.length;for(e=0;e<a;++e)if(b=d[c[e]],this.octree_.aabbLoose_.isOutside(b.aabb_)){c=new Aabb;c.copy(this.octree_.aabbSplit_);e=[0,0,0];vec3.scale(e,vec3.sub(e,c.max_,c.min_),0.2);vec3.sub(c.min_,c.min_,e);vec3.add(c.max_,c.max_,e);g=[];d=d.length;for(e=0;e<d;++e)g.push(e);this.octree_=new Octree;this.octree_.aabbSplit_=c;this.octree_.build(this,g);
this.leavesUpdate_.length=0;break}else g=b.leaf_,this.octree_.addTriangle(b),g===b.leaf_&&(g=g.iTris_,b.posInLeaf_=g.length,g.push(c[e]))},checkLeavesUpdate:function(){Utils.tidy(this.leavesUpdate_);for(var a=this.leavesUpdate_,b=a.length,c=[],d=Octree.maxTriangles_,e=Octree.maxDepth_,g=0;g<b;++g){var k=a[g];if(null===k)break;k.iTris_.length?k.iTris_.length>d&&k.depth_<e&&k.constructCells(this):k.checkEmptiness(c)}this.leavesUpdate_.length=0}};function Background(a){this.gl_=a;this.backgroundTexUnif_=this.texAttrib_=this.vertexAttrib_=this.vertexShader_=this.fragmentShader_=this.shaderProgram_=this.backgroundLoc_=this.texBuffer_=this.vertexBuffer_=null}
Background.prototype={initShaders:function(a){var b=this.gl_;this.loadShaders(a.backgroundVertex,a.backgroundFragment);a=this.shaderProgram_=b.createProgram();b.attachShader(a,this.vertexShader_);b.attachShader(a,this.fragmentShader_);b.linkProgram(a);b.useProgram(a);this.vertexAttrib_=b.getAttribLocation(this.shaderProgram_,"vertex");this.texAttrib_=b.getAttribLocation(this.shaderProgram_,"texCoord");this.backgroundTexUnif_=b.getUniformLocation(a,"backgroundTex");b.detachShader(a,this.fragmentShader_);
b.deleteShader(this.fragmentShader_);b.detachShader(a,this.vertexShader_);b.deleteShader(this.vertexShader_)},loadShaders:function(a,b){var c=this.gl_;this.vertexShader_=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vertexShader_,a);c.compileShader(this.vertexShader_);this.fragmentShader_=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fragmentShader_,b);c.compileShader(this.fragmentShader_)},initBuffer:function(){var a=this.gl_;this.vertexBuffer_=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,
this.vertexBuffer_);a.bufferData(a.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,-1,-1,1,1,1,1,-1]),a.DYNAMIC_DRAW);this.texBuffer_=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.texBuffer_);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,0,0,1,0,1,1]),a.DYNAMIC_DRAW)},init:function(a){this.initBuffer();this.initShaders(a)},loadBackgroundTexture:function(a){var b=this.gl_;this.backgroundLoc_&&b.deleteTexture(this.backgroundLoc_);this.backgroundLoc_=b.createTexture();b.bindTexture(b.TEXTURE_2D,
this.backgroundLoc_);b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.bindTexture(b.TEXTURE_2D,null)},render:function(){var a=this.gl_;a.useProgram(this.shaderProgram_);a.enableVertexAttribArray(this.vertexAttrib_);a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer_);a.vertexAttribPointer(this.vertexAttrib_,
2,a.FLOAT,!1,0,0);a.enableVertexAttribArray(this.texAttrib_);a.bindBuffer(a.ARRAY_BUFFER,this.texBuffer_);a.vertexAttribPointer(this.texAttrib_,2,a.FLOAT,!1,0,0);a.activeTexture(a.TEXTURE0);a.bindTexture(a.TEXTURE_2D,this.backgroundLoc_);a.uniform1i(this.backgroundTexUnif_,0);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);a.drawArrays(a.TRIANGLES,0,6)}};function Octree(a,b){this.parent_=void 0!==a?a:null;this.depth_=void 0!==b?b:0;this.children_=[];this.aabbLoose_=new Aabb;this.aabbSplit_=new Aabb;this.iTris_=[]}Octree.maxDepth_=8;Octree.maxTriangles_=100;
Octree.prototype={build:function(a,b){var c=this.aabbLoose_;c.copy(this.aabbSplit_);this.iTris_=b;var d=b.length;if(d>Octree.maxTriangles_&&this.depth_<Octree.maxDepth_)this.constructCells(a);else if(0<d){for(var e=Infinity,g=Infinity,k=Infinity,f=-Infinity,h=-Infinity,l=-Infinity,m=a.triangles_,n=0;n<d;++n){var p=m[b[n]];p.leaf_=this;p.posInLeaf_=n;var p=p.aabb_,q=p.min_,r=p.max_,p=q[0],s=q[1],q=q[2],u=r[0],v=r[1],r=r[2];u>f&&(f=u);p<e&&(e=p);v>h&&(h=v);s<g&&(g=s);r>l&&(l=r);q<k&&(k=q)}c.set(e,g,
k,f,h,l);for(d=this.parent_;null!==d;)d.aabbLoose_.expandsWithAabb(c),d=d.parent_}},constructCells:function(a){for(var b=this.aabbSplit_.min_,c=this.aabbSplit_.max_,d=b[0],e=b[1],g=b[2],b=c[0],k=c[1],c=c[2],f=0.5*(b-d),h=0.5*(k-e),l=0.5*(c-g),m=0.5*(b+d),n=0.5*(k+e),p=0.5*(c+g),q=[],r=[],s=[],u=[],v=[],w=[],t=[],x=[],y=a.triangles_,C=this.iTris_,z=C.length,F=0;F<z;++F){var A=C[F],D=y[A].aabb_.center_,E=D[1],B=D[2];D[0]>m?E>n?B>p?t.push(A):w.push(A):B>p?s.push(A):r.push(A):E>n?B>p?x.push(A):v.push(A):
B>p?u.push(A):q.push(A)}z=this.depth_+1;y=new Octree(this,z);y.aabbSplit_.set(d,e,g,m,n,p);y.build(a,q);q=new Octree(this,z);q.aabbSplit_.set(d+f,e,g,m+f,n,p);q.build(a,r);r=new Octree(this,z);r.aabbSplit_.set(m,n-h,p,b,k-h,c);r.build(a,s);s=new Octree(this,z);s.aabbSplit_.set(d,e,g+l,m,n,p+l);s.build(a,u);u=new Octree(this,z);u.aabbSplit_.set(d,e+h,g,m,n+h,p);u.build(a,v);d=new Octree(this,z);d.aabbSplit_.set(m,n,p-l,b,k,c-l);d.build(a,w);e=new Octree(this,z);e.aabbSplit_.set(m,n,p,b,k,c);e.build(a,
t);t=new Octree(this,z);t.aabbSplit_.set(m-f,n,p,b-f,k,c);t.build(a,x);this.children_.length=0;this.children_.push(y,q,r,s,u,d,e,t);C.length=0},intersectRay:function(a,b){if(this.aabbLoose_.intersectRay(a,b)){if(8===this.children_.length){for(var c=[],d=this.children_,e=0;8>e;++e){var g=d[e].intersectRay(a,b);c.push.apply(c,g)}return c}return this.iTris_}return[]},intersectSphere:function(a,b,c){if(this.aabbSplit_.intersectSphere(a,b)){if(8===this.children_.length){for(var d=[],e=this.children_,g=
0;8>g;++g){var k=e[g].intersectSphere(a,b,c);d.push.apply(d,k)}return d}c.push(this);return this.iTris_}return[]},cullPlane:function(a,b,c,d){var e=this.aabbSplit_.intersectPlane(a,b);if(0<e)if(8===this.children_.length)for(var e=this.children_,g=0;8>g;++g)e[g].cullPlane(a,b,c,d);else 1===e?c.push.apply(c,this.iTris_):d.push.apply(d,this.iTris_)},addTriangle:function(a){if(this.aabbSplit_.pointInside(a.aabb_.center_)){this.aabbLoose_.expandsWithAabb(a.aabb_);var b=this.children_;if(8===b.length)for(var c=
0;8>c;++c)b[c].addTriangle(a);else a.posInLeaf_=this.iTris_.length,a.leaf_=this,this.iTris_.push(a.id_)}},checkEmptiness:function(){var a=this.parent_;if(a&&8===a.children_.length){for(var b=a.children_,c=0;8>c;++c){var d=b[c];if(0<d.iTris_.length||8===d.children_.length)return}b.length=0;a.checkEmptiness()}}};function Picking(a){this.mesh_=null;this.pickedTriangle_=-1;this.pickedVertices_=[];this.interPoint_=[0,0,0];this.rDisplay_=50;this.rWorldSqr_=0;this.camera_=a;this.eyeDir_=[0,0,0]}
Picking.prototype={intersectionMouseMesh:function(a,b,c,d,e,g){var k=this.camera_.unproject(b,c,0),f=this.camera_.unproject(b,c,1),h=mat4.create();mat4.invert(h,a.matTransform_);vec3.transformMat4(k,k,h);vec3.transformMat4(f,f,h);e&&(Geometry.mirrorPoint(k,e,g),Geometry.mirrorPoint(f,e,g));this.intersectionRayMesh(a,k,f,b,c,d);a=this.eyeDir_;vec3.sub(a,f,k);vec3.normalize(a,a)},intersectionRayMesh:function(){var a=[0,0,0],b=[0,0,0],c=[0,0,0],d=[0,0,0],e=[0,0,0],g=[0,0,0];return function(k,f,h,l,m,
n){this.mesh_=null;this.pickedTriangle_=-1;var p=k.vertexArray_,q=k.indexArray_;vec3.sub(d,h,f);vec3.normalize(d,d);e[0]=1/d[0];e[1]=1/d[1];e[2]=1/d[2];h=k.octree_.intersectRay(f,e);for(var r=-1,s=h.length,u=0;u<s;++u){var v=3*h[u],w=3*q[v],t=3*q[v+1],v=3*q[v+2];a[0]=p[w];a[1]=p[w+1];a[2]=p[w+2];b[0]=p[t];b[1]=p[t+1];b[2]=p[t+2];c[0]=p[v];c[1]=p[v+1];c[2]=p[v+2];if(Geometry.intersectionRayTriangle(f,d,a,b,c,g)&&(w=vec3.sqrDist(f,g),w<r||0>r))r=w,vec3.copy(this.interPoint_,g),this.pickedTriangle_=
h[u]}-1!==this.pickedTriangle_?(this.mesh_=k,this.computeRadiusWorldSq(l,m,n)):this.rWorldSqr_=0}}(),pickVerticesInSphere:function(a){this.pickedVertices_=[];for(var b=this.mesh_.vertices_,c=this.mesh_.vertexArray_,d=this.mesh_.octree_.intersectSphere(this.interPoint_,a,this.mesh_.leavesUpdate_),d=this.mesh_.getVerticesFromTriangles(d),e=d.length,g=++Vertex.sculptMask_,k=this.pickedVertices_,f=this.interPoint_,h=f[0],l=f[1],f=f[2],m=0,n=m=0;n<e;++n){var m=d[n],p=b[m],m=3*m,q=h-c[m],r=l-c[m+1],m=f-
c[m+2];q*q+r*r+m*m<a&&(p.sculptFlag_=g,k.push(d[n]))}0===this.pickedVertices_.length&&-1!==this.pickedTriangle_&&(a=this.mesh_.indexArray_,m=3*this.pickedTriangle_,this.pickedVertices_.push(a[m],a[m+1],a[m+2]))},computeRadiusWorldSq:function(a,b,c){var d=[0,0,0];vec3.transformMat4(d,this.interPoint_,this.mesh_.matTransform_);var e=this.camera_.project(d)[2];a=this.camera_.unproject(a+this.rDisplay_*c,b,e);this.rWorldSqr_=vec3.sqrDist(d,a)}};function Render(a,b){this.mesh_=b;this.gl_=a;this.shader_=new Shader(a);this.flatShading_=!1;this.cacheDrawArraysC_=this.cacheDrawArraysN_=this.cacheDrawArraysV_=this.reflectionLoc_=this.indexBuffer_=this.colorBuffer_=this.normalBuffer_=this.vertexBuffer_=null}
Render.prototype={updateShaders:function(a,b,c){a>=Shader.mode.MATERIAL&&(this.reflectionLoc_=b[a]);this.shader_.type_=a;this.shader_.init(c)},initBuffers:function(){var a=this.gl_;this.vertexBuffer_=a.createBuffer();this.normalBuffer_=a.createBuffer();this.colorBuffer_=a.createBuffer();this.indexBuffer_=a.createBuffer()},render:function(a,b,c,d){var e=this.gl_,g=this.shader_,k=3*this.mesh_.triangles_.length;e.useProgram(g.program_);var f=b.interPoint_;b=b.rWorldSqr_;var h=mat4.create();mat4.mul(h,
a.view_,this.mesh_.matTransform_);var l=mat4.create();mat4.mul(l,a.proj_,h);e.enableVertexAttribArray(g.vertexAttrib_);e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer_);e.vertexAttribPointer(g.vertexAttrib_,3,e.FLOAT,!1,0,0);e.enableVertexAttribArray(g.normalAttrib_);e.bindBuffer(e.ARRAY_BUFFER,this.normalBuffer_);g.type_===Shader.mode.WIREFRAME?e.vertexAttribPointer(g.normalAttrib_,4,e.FLOAT,!1,0,0):e.vertexAttribPointer(g.normalAttrib_,3,e.FLOAT,!1,0,0);g.type_!==Shader.mode.WIREFRAME&&g.type_!==
Shader.mode.NORMAL&&(e.enableVertexAttribArray(g.colorAttrib_),e.bindBuffer(e.ARRAY_BUFFER,this.colorBuffer_),e.vertexAttribPointer(g.colorAttrib_,3,e.FLOAT,!1,0,0));e.uniformMatrix4fv(g.mvMatrixUnif_,!1,h);e.uniformMatrix4fv(g.mvpMatrixUnif_,!1,l);e.uniformMatrix3fv(g.normalMatrixUnif_,!1,mat3.normalFromMat4(mat3.create(),h));e.uniform3fv(g.centerPickingUnif_,vec3.transformMat4([0,0,0],f,h));e.uniform1f(g.radiusSquaredUnif_,b);e.uniform2fv(g.lineOriginUnif_,c);e.uniform2fv(g.lineNormalUnif_,d);switch(g.type_){case Shader.mode.PHONG:this.drawBuffer(k);
break;case Shader.mode.TRANSPARENCY:e.depthMask(!1);e.enable(e.BLEND);this.drawBuffer(k);e.disable(e.BLEND);e.depthMask(!0);break;case Shader.mode.WIREFRAME:e.drawArrays(e.TRIANGLES,0,k);break;case Shader.mode.NORMAL:this.drawBuffer(k);break;default:e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.reflectionLoc_),e.uniform1i(this.reflectionTexUnif_,0),this.drawBuffer(k)}},drawBuffer:function(a){var b=this.gl_;!0===this.flatShading_?b.drawArrays(b.TRIANGLES,0,a):(b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
this.indexBuffer_),b.drawElements(b.TRIANGLES,a,SculptGL.elementIndexType,0))},updateBuffers:function(){if(this.shader_.type_===Shader.mode.WIREFRAME)this.makeWireframeBuffers();else if(!0===this.flatShading_)this.flatShadingBuffers();else{var a=this.gl_,b=this.mesh_;a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer_);a.bufferData(a.ARRAY_BUFFER,b.vertexArray_,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer_);a.bufferData(a.ARRAY_BUFFER,b.normalArray_,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,
this.colorBuffer_);a.bufferData(a.ARRAY_BUFFER,b.colorArray_,a.DYNAMIC_DRAW);a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.indexBuffer_);a.bufferData(a.ELEMENT_ARRAY_BUFFER,b.indexArray_,a.STATIC_DRAW)}},flatShadingBuffers:function(){var a=this.gl_,b=this.mesh_,c=b.triangles_,d=c.length,e=b.vertexArray_,g=b.colorArray_,b=b.indexArray_,k=this.cacheDrawArraysV_,f=this.cacheDrawArraysN_,h=this.cacheDrawArraysC_;if(null===k||k.length<=9*d)k=this.cacheDrawArraysV_=new Float32Array(13.5*d);if(null===f||f.length<=
9*d)f=this.cacheDrawArraysN_=new Float32Array(13.5*d);if(null===h||h.length<=9*d)h=this.cacheDrawArraysC_=new Float32Array(13.5*d);for(var l=0,m=0,n=0,d=3*d,l=0;l<d;++l){m=3*l;n=3*b[l];k[m]=e[n];k[m+1]=e[n+1];k[m+2]=e[n+2];var p=c[Math.floor(l/3)].normal_;f[m]=p[0];f[m+1]=p[1];f[m+2]=p[2];h[m]=g[n];h[m+1]=g[n+1];h[m+2]=g[n+2]}a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer_);a.bufferData(a.ARRAY_BUFFER,k,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer_);a.bufferData(a.ARRAY_BUFFER,f,a.DYNAMIC_DRAW);
a.bindBuffer(a.ARRAY_BUFFER,this.colorBuffer_);a.bufferData(a.ARRAY_BUFFER,h,a.DYNAMIC_DRAW)},makeWireframeBuffers:function(){var a=this.gl_,b=this.mesh_,c=b.triangles_.length,d=b.vertexArray_,e=b.normalArray_,b=b.indexArray_,g=this.cacheDrawArraysV_,k=this.cacheDrawArraysN_;if(null===g||g.length<=9*c)g=this.cacheDrawArraysV_=new Float32Array(13.5*c);if(null===k||k.length<=12*c)k=this.cacheDrawArraysN_=new Float32Array(18*c);for(var f=0,h=0,l=0,c=3*c,f=0;f<c;++f)h=3*f,l=3*b[f],g[h]=d[l],g[h+1]=d[l+
1],g[h+2]=d[l+2],h=4*f,k[h]=e[l],k[h+1]=e[l+1],k[h+2]=e[l+2],k[h+3]=f%3;a.bindBuffer(a.ARRAY_BUFFER,this.vertexBuffer_);a.bufferData(a.ARRAY_BUFFER,g,a.DYNAMIC_DRAW);a.bindBuffer(a.ARRAY_BUFFER,this.normalBuffer_);a.bufferData(a.ARRAY_BUFFER,k,a.DYNAMIC_DRAW)}};function Shader(a){this.gl_=a;this.type_=Shader.mode.MATERIAL+2;this.reflectionTexUnif_=this.lineNormalUnif_=this.lineOriginUnif_=this.radiusSquaredUnif_=this.centerPickingUnif_=this.normalMatrixUnif_=this.mvMatrixUnif_=this.mvpMatrixUnif_=this.normalAttrib_=this.colorAttrib_=this.vertexAttrib_=this.vertexShader_=this.fragmentShader_=this.program_=null}Shader.mode={PHONG:0,TRANSPARENCY:1,WIREFRAME:2,NORMAL:3,MATERIAL:4};
Shader.prototype={init:function(a){var b=this.gl_;switch(this.type_){case Shader.mode.PHONG:this.loadShaders(a.phongVertex,a.phongFragment);break;case Shader.mode.WIREFRAME:this.loadShaders(a.wireframeVertex,a.wireframeFragment);break;case Shader.mode.TRANSPARENCY:this.loadShaders(a.transparencyVertex,a.transparencyFragment);break;case Shader.mode.NORMAL:this.loadShaders(a.normalVertex,a.normalFragment);break;default:this.loadShaders(a.reflectionVertex,a.reflectionFragment)}this.program_&&b.deleteProgram(this.program_);
a=this.program_=b.createProgram();b.attachShader(a,this.vertexShader_);b.attachShader(a,this.fragmentShader_);b.linkProgram(a);b.useProgram(a);this.vertexAttrib_=b.getAttribLocation(a,"vertex");this.normalAttrib_=b.getAttribLocation(a,"normal");this.type_!==Shader.mode.NORMAL&&this.type_!==Shader.mode.WIREFRAME&&(this.colorAttrib_=b.getAttribLocation(a,"color"));this.mvpMatrixUnif_=b.getUniformLocation(a,"mvpMat");this.mvMatrixUnif_=b.getUniformLocation(a,"mvMat");this.normalMatrixUnif_=b.getUniformLocation(a,
"nMat");this.centerPickingUnif_=b.getUniformLocation(a,"centerPicking");this.radiusSquaredUnif_=b.getUniformLocation(a,"radiusSquared");this.lineOriginUnif_=b.getUniformLocation(a,"lineOrigin");this.lineNormalUnif_=b.getUniformLocation(a,"lineNormal");this.type_>=Shader.mode.MATERIAL&&(this.reflectionTexUnif_=b.getUniformLocation(a,"refTex"));b.detachShader(a,this.fragmentShader_);b.deleteShader(this.fragmentShader_);b.detachShader(a,this.vertexShader_);b.deleteShader(this.vertexShader_)},loadShaders:function(a,
b){var c=this.gl_;this.vertexShader_=c.createShader(c.VERTEX_SHADER);c.shaderSource(this.vertexShader_,a);c.compileShader(this.vertexShader_);this.fragmentShader_=c.createShader(c.FRAGMENT_SHADER);c.shaderSource(this.fragmentShader_,b);c.compileShader(this.fragmentShader_)}};function Sculpt(a){this.states_=a;this.mesh_=null;this.intensity_=0.75;this.tool_=Sculpt.tool.BRUSH;this.topo_=Sculpt.topo.SUBDIVISION;this.detailSubdivision_=0.75;this.detailDecimation_=0.1;this.negative_=!1;this.clay_=!0;this.culling_=!1;this.color_=[168,66,66];this.d2Max_=this.d2Min_=0;this.d2Thickness_=0.5;this.d2Move_=0;this.rotateData_={normal:[0,0,0],center:[0,0]};this.rotateDataSym_={normal:[0,0,0],center:[0,0]};this.dragDir_=[0,0,0];this.dragDirSym_=[0,0,0];this.lineOrigin_=[0,0];this.lineNormal_=
[0,0];this.fillHoles_=!0;this.subdDetailCut_=2}Sculpt.tool={BRUSH:0,INFLATE:1,ROTATE:2,SMOOTH:3,FLATTEN:4,PINCH:5,CREASE:6,DRAG:7,COLOR:8,SCALE:9,CUT:10};Sculpt.topo={STATIC:0,SUBDIVISION:1,ADAPTIVE:2};
Sculpt.prototype={setAdaptiveParameters:function(a){this.d2Max_=0.2*a*(1.1-this.detailSubdivision_);this.d2Min_=this.d2Max_/4.2025;this.d2Move_=0.2375*this.d2Min_;this.d2Thickness_=1.1*(4*this.d2Move_+this.d2Max_/3)},sculptStroke:function(a,b,c,d,e){if(this.tool_===Sculpt.tool.ROTATE)return this.sculptStrokeRotate(a,b,d,e);if(this.tool_===Sculpt.tool.SCALE)return this.sculptStrokeScale(a,b,d,e);var g=e.ptPlane_,k=e.nPlane_,f=e.picking_,h=e.pickingSym_,l=e.lastMouseX_,m=e.lastMouseY_,n=a-l,p=b-m,q=
Math.sqrt(n*n+p*p);e.sumDisplacement_+=q;var r=e.sumDisplacement_,s=0.2*f.rDisplay_,u=q/Math.floor(q/s),n=n/q,p=p/q;e.continuous_?q=r=0:(a=l,b=m);var l=e.mesh_,m=e.symmetry_,v=this.tool_===Sculpt.tool.DRAG;if(v){s=0;f.mesh_=h.mesh_=l;var w=f.interPoint_,t=h.interPoint_;t[0]=w[0];t[1]=w[1];t[2]=w[2];Geometry.mirrorPoint(t,g,k)}if(r>100*s&&!v)r=0;else if(r>s||0===r){for(s=r=0;s<=q;s+=u){v?this.updateDragDir(l,f,a,b,c):f.intersectionMouseMesh(l,a,b,c);if(!f.mesh_)break;f.pickVerticesInSphere(f.rWorldSqr_);
this.sculptMesh(f,d);if(m){v?this.updateDragDir(l,h,a,b,c,g,k):h.intersectionMouseMesh(l,a,b,c,g,k);if(!h.mesh_)break;h.rWorldSqr_=f.rWorldSqr_;h.pickVerticesInSphere(h.rWorldSqr_);this.sculptMesh(h,d,!0)}a+=n*u;b+=p*u}this.mesh_.updateBuffers()}e.sumDisplacement_=r},sculptStrokeScale:function(a,b,c,d){d.picking_.mesh_&&(d.picking_.pickVerticesInSphere(d.picking_.rWorldSqr_),this.sculptMesh(d.picking_,c,!1,a,b,d.lastMouseX_,d.lastMouseY_),d.symmetry_&&(d.pickingSym_.pickVerticesInSphere(d.pickingSym_.rWorldSqr_),
this.sculptMesh(d.pickingSym_,c,!0,a,b,d.lastMouseX_,d.lastMouseY_)),this.mesh_.updateBuffers())},sculptStrokeRotate:function(a,b,c,d){d.picking_.mesh_&&(d.picking_.pickVerticesInSphere(d.picking_.rWorldSqr_),this.sculptMesh(d.picking_,c,!1,a,b,d.lastMouseX_,d.lastMouseY_),d.symmetry_&&(d.pickingSym_.pickVerticesInSphere(d.pickingSym_.rWorldSqr_),this.sculptMesh(d.pickingSym_,c,!0,d.lastMouseX_,d.lastMouseY_,a,b)),this.mesh_.updateBuffers())},sculptMesh:function(a,b,c,d,e,g,k){var f=this.mesh_,h=
a.pickedVertices_,l=a.rWorldSqr_,m=a.interPoint_,n=a.eyeDir_;a=f.vertices_;var p=f.getTrianglesFromVertices(h);b*=this.intensity_;this.states_.pushState(p,h);var q=new Topology(this.states_);q.mesh_=f;q.radiusSquared_=l;q.center_=m;this.setAdaptiveParameters(l);switch(this.topo_){case Sculpt.topo.SUBDIVISION:0<this.detailSubdivision_&&(p=q.subdivision(p,this.d2Max_));0<this.detailDecimation_&&(p=q.decimation(p,this.d2Min_*this.detailDecimation_));break;case Sculpt.topo.ADAPTIVE:p=q.subdivision(p,
this.d2Max_),p=q.decimation(p,this.d2Min_)}for(var h=f.getVerticesFromTriangles(p),r=h.length,s=[],u=[],v=Vertex.sculptMask_,w=f.normalArray_,t=n[0],x=n[1],n=n[2],y=0;y<r;++y){var C=h[y];if(a[C].sculptFlag_===v){s.push(C);var z=3*C;0>=w[z]*t+w[z+1]*x+w[z+2]*n&&u.push(C)}}if(0!==u.length)switch(this.culling_&&(s=u),this.tool_){case Sculpt.tool.BRUSH:this.brush(m,s,u,l,b);break;case Sculpt.tool.INFLATE:this.inflate(m,s,l,b);break;case Sculpt.tool.ROTATE:this.rotate(m,s,l,d,e,g,k,c);break;case Sculpt.tool.SMOOTH:this.smooth(s,
b);break;case Sculpt.tool.FLATTEN:this.flatten(m,s,u,l,b);break;case Sculpt.tool.PINCH:this.pinch(m,s,l,b);break;case Sculpt.tool.CREASE:this.crease(m,s,u,l,b);break;case Sculpt.tool.DRAG:this.drag(m,s,l,c);break;case Sculpt.tool.COLOR:this.paint(m,s,l);break;case Sculpt.tool.SCALE:this.scale(m,s,l,d-g)}this.topo_===Sculpt.topo.ADAPTIVE&&(p=q.adaptTopology(p,this.d2Thickness_),h=f.getVerticesFromTriangles(p));f.updateMesh(p,h)},brush:function(a,b,c,d,e){var g=this.areaNormal(c);if(g){var k=this.areaCenter(c);
c=this.mesh_.vertexArray_;d=Math.sqrt(d);var f=b.length,h=0.1*e*d;e=this.clay_?e:0.3*e;this.negative_&&(h=-h);var l=a[0],m=a[1];a=a[2];for(var n=k[0],p=k[1],k=k[2],q=g[0],r=g[1],g=g[2],s=this.topo_===Sculpt.topo.ADAPTIVE,u=Math.sqrt(this.d2Move_),v=0;v<f;++v){var w=3*b[v],t=c[w],x=c[w+1],y=c[w+2],C=(t-n)*q+(x-p)*r+(y-k)*g,t=t-l,x=x-m,y=y-a,y=Math.sqrt(t*t+x*x+y*y)/d,t=y*y,t=3*t*t-4*t*y+1,t=t*(C*e-h);s&&t>u&&(t=u);c[w]-=q*t;c[w+1]-=r*t;c[w+2]-=g*t}}},inflate:function(a,b,c,d){var e=this.mesh_,g=e.vertexArray_,
e=e.normalArray_,k=b.length;c=Math.sqrt(c);d=0.1*d*c;this.topo_===Sculpt.topo.ADAPTIVE&&(d=Math.min(Math.sqrt(this.d2Move_),d));this.negative_&&(d=-d);var f=a[0],h=a[1];a=a[2];for(var l=0;l<k;++l){var m=3*b[l],n=g[m]-f,p=g[m+1]-h,q=g[m+2]-a,n=Math.sqrt(n*n+p*p+q*q)/c,p=n*n,p=3*p*p-4*p*n+1,p=d*p;g[m]+=e[m]*p;g[m+1]+=e[m+1]*p;g[m+2]+=e[m+2]*p}},startScale:function(a,b,c,d,e,g,k){var f=a.camera_.unproject(b,c,0),h=a.camera_.unproject(b,c,1),l=mat4.create();mat4.invert(l,this.mesh_.matTransform_);vec3.transformMat4(f,
f,l);vec3.transformMat4(h,h,l);a.intersectionRayMesh(this.mesh_,f,h,b,c,1);a.mesh_&&(a.pickVerticesInSphere(a.rWorldSqr_),k&&(k=[f[0],f[1],f[2]],Geometry.mirrorPoint(k,e,g),h=[h[0],h[1],h[2]],Geometry.mirrorPoint(h,e,g),d.intersectionRayMesh(this.mesh_,k,h,b,c,1),d.mesh_&&(d.rWorldSqr_=a.rWorldSqr_,d.pickVerticesInSphere(d.rWorldSqr_))))},scale:function(a,b,c,d){var e=this.mesh_.vertexArray_;d*=0.01;c=Math.sqrt(c);var g=b.length,k=a[0],f=a[1];a=a[2];for(var h=0;h<g;++h){var l=3*b[h],m=e[l]-k,n=e[l+
1]-f,p=e[l+2]-a,q=Math.sqrt(m*m+n*n+p*p)/c,r=q*q,r=3*r*r-4*r*q+1,r=r*d;e[l]+=m*r;e[l+1]+=n*r;e[l+2]+=p*r}},startRotate:function(a,b,c,d,e,g,k){var f=a.camera_.unproject(b,c,0),h=a.camera_.unproject(b,c,1),l=mat4.create();mat4.invert(l,this.mesh_.matTransform_);vec3.transformMat4(f,f,l);vec3.transformMat4(h,h,l);this.initRotateData(a,f,h,b,c,this.rotateData_);k&&(k=[f[0],f[1],f[2]],Geometry.mirrorPoint(k,e,g),h=[h[0],h[1],h[2]],Geometry.mirrorPoint(h,e,g),this.initRotateData(d,k,h,b,c,this.rotateDataSym_),
d.rWorldSqr_=a.rWorldSqr_)},initRotateData:function(a,b,c,d,e,g){a.intersectionRayMesh(this.mesh_,b,c,d,e,1);a.mesh_&&(a.pickVerticesInSphere(a.rWorldSqr_),a=[0,0,0],vec3.sub(a,b,c),g.normal=vec3.normalize(a,a),g.center=[d,e])},rotate:function(a,b,c,d,e,g,k,f){var h=this.rotateData_;f&&(h=this.rotateDataSym_);f=h.center;e=[d-f[0],e-f[1]];if(!(30>vec2.len(e))){vec2.normalize(e,e);h=h.normal;d=[0,0,0,0];g=[g-f[0],k-f[1]];vec2.normalize(g,g);g=Geometry.signedAngle2d(e,g);k=this.mesh_.vertexArray_;c=
Math.sqrt(c);f=b.length;e=a[0];var l=a[1];a=a[2];for(var m=[0,0,0],n=0;n<f;++n){var p=3*b[n],q=k[p]-e,r=k[p+1]-l,s=k[p+2]-a,q=Math.sqrt(q*q+r*r+s*s)/c,r=q*q,r=3*r*r-4*r*q+1;quat.setAxisAngle(d,h,g*r);m[0]=k[p]-e;m[1]=k[p+1]-l;m[2]=k[p+2]-a;vec3.transformQuat(m,m,d);m[0]+=e;m[1]+=l;m[2]+=a;k[p]=m[0];k[p+1]=m[1];k[p+2]=m[2]}}},smooth:function(a,b){var c=this.mesh_.vertexArray_,d=a.length,e=new Float32Array(3*d);this.laplacianSmooth(a,e);for(var g=this.d2Move_,k=Math.sqrt(g),f=this.topo_===Sculpt.topo.ADAPTIVE,
h=0;h<d;++h){var l=3*a[h],m=3*h,n=(e[m]-c[l])*b,p=(e[m+1]-c[l+1])*b,m=(e[m+2]-c[l+2])*b;if(f){var q=n*n+p*p+m*m;q>g&&(q=k/Math.sqrt(q),n*=q,p*=q,m*=q)}c[l]+=n;c[l+1]+=p;c[l+2]+=m}},flatten:function(a,b,c,d,e){var g=this.areaNormal(c);if(g){var k=this.areaCenter(c);c=this.mesh_.vertexArray_;d=Math.sqrt(d);var f=b.length;e*=0.3;var h=a[0],l=a[1];a=a[2];for(var m=k[0],n=k[1],k=k[2],p=g[0],q=g[1],g=g[2],r=Math.sqrt(this.d2Move_),s=this.topo_===Sculpt.topo.ADAPTIVE,u=0;u<f;++u){var v=3*b[u],w=c[v],t=c[v+
1],x=c[v+2],y=(w-m)*p+(t-n)*q+(x-k)*g,w=w-h,t=t-l,x=x-a,x=Math.sqrt(w*w+t*t+x*x)/d,w=x*x,w=3*w*w-4*w*x+1,w=y*e*w;s&&w>r&&(w=r);c[v]-=p*w;c[v+1]-=q*w;c[v+2]-=g*w}}},pinch:function(a,b,c,d){var e=this.mesh_.vertexArray_;c=Math.sqrt(c);var g=b.length,k=a[0],f=a[1];a=a[2];var h=this.d2Move_,l=Math.sqrt(h),m=this.topo_===Sculpt.topo.ADAPTIVE;d=0.005*d*c;for(var n=0;n<g;++n){var p=3*b[n],q=k-e[p],r=f-e[p+1],s=a-e[p+2],u=Math.sqrt(q*q+r*r+s*s)/c,v=u*u,v=3*v*v-4*v*u+1,v=d*v,q=q*v,r=r*v,s=s*v;m&&(u=q*q+r*
r+s*s,u>h&&(u=l/Math.sqrt(u),q*=u,r*=u,s*=u));e[p]+=q;e[p+1]+=r;e[p+2]+=s}},crease:function(a,b,c,d,e){var g=this.areaNormal(c);if(g){c=this.mesh_.vertexArray_;d=Math.sqrt(d);var k=b.length,f=a[0],h=a[1];a=a[2];var l=g[0],m=g[1],g=g[2],n=this.d2Move_,p=Math.sqrt(n),q=this.topo_===Sculpt.topo.ADAPTIVE;e=0.005*e*d;var r=10;this.negative_&&(r=-10);for(var s=0;s<k;++s){var u=3*b[s],v=f-c[u],w=h-c[u+1],t=a-c[u+2],x=Math.sqrt(v*v+w*w+t*t)/d,y=x*x,y=3*y*y-4*y*x+1,x=e*Math.pow(2-y,-5)*r,y=0.1*y,v=v*y+l*x,
w=w*y+m*x,t=t*y+g*x;q&&(y=v*v+w*w+t*t,y>n&&(y=p/Math.sqrt(y),v*=y,w*=y,t*=y));c[u]+=v;c[u+1]+=w;c[u+2]+=t}}},updateDragDir:function(a,b,c,d,e,g,k){var f=b.camera_.unproject(c,d,0),h=b.camera_.unproject(c,d,1),l=mat4.create();mat4.invert(l,a.matTransform_);vec3.transformMat4(f,f,l);vec3.transformMat4(h,h,l);l=this.dragDir_;g&&(l=this.dragDirSym_,Geometry.mirrorPoint(f,g,k),Geometry.mirrorPoint(h,g,k));g=b.interPoint_;b.interPoint_=Geometry.vertexOnLine(g,f,h);vec3.sub(l,b.interPoint_,g);b.mesh=a;b.computeRadiusWorldSq(c,
d,e);a=b.eyeDir_;vec3.sub(a,h,f);vec3.normalize(a,a)},drag:function(a,b,c,d){var e=this.mesh_.vertexArray_,g=b.length;c=Math.sqrt(c);var k=a[0],f=a[1];a=a[2];var h=d?this.dragDirSym_:this.dragDir_;d=h[0];for(var l=h[1],h=h[2],m=0;m<g;++m){var n=3*b[m],p=e[n]-k,q=e[n+1]-f,r=e[n+2]-a,p=Math.sqrt(p*p+q*q+r*r)/c,q=p*p,q=3*q*q-4*q*p+1;e[n]+=d*q;e[n+1]+=l*q;e[n+2]+=h*q}},paint:function(a,b,c){var d=this.mesh_,e=d.vertexArray_,d=d.colorArray_,g=this.color_;c=Math.sqrt(c);var k=g[0]/255,f=g[1]/255,g=g[2]/
255,h=a[0],l=a[1];a=a[2];for(var m=this.intensity_,n=b.length,p=0;p<n;++p){var q=3*b[p],r=e[q]-h,s=e[q+1]-l,u=e[q+2]-a,s=Math.sqrt(r*r+s*s+u*u)/c,r=s*s,r=3*r*r-4*r*s+1,r=r*m,s=1-r;d[q]=d[q]*s+k*r;d[q+1]=d[q+1]*s+f*r;d[q+2]=d[q+2]*s+g*r}},smoothFlat:function(a,b){var c=this.mesh_,d=c.vertexArray_,c=c.normalArray_,e=a.length,g=new Float32Array(3*e);this.laplacianSmooth(a,g);for(var k=0;k<e;++k){var f=3*a[k],h=d[f],l=d[f+1],m=d[f+2],n=c[f],p=c[f+1],q=c[f+2],r=3*k,s=g[r],u=g[r+1],r=g[r+2],v=n*(s-h)+p*
(u-l)+q*(r-m);d[f]+=(s-n*v-h)*b;d[f+1]+=(u-p*v-l)*b;d[f+2]+=(r-q*v-m)*b}},laplacianSmooth:function(a,b){for(var c=this.mesh_,d=c.vertices_,c=c.vertexArray_,e=a.length,g=0;g<e;++g){var k=3*g,f=d[a[g]],h=f.ringVertices_,l=h.length,m=0,n=0,p=0,q=0,r=0;if(l!==f.tIndices_.length){for(q=f=0;q<l;++q){var r=h[q],s=d[r];s.ringVertices_.length!==s.tIndices_.length&&(r*=3,m+=c[r],n+=c[r+1],p+=c[r+2],++f)}b[k]=m/f;b[k+1]=n/f;b[k+2]=p/f}else{for(q=0;q<l;++q)r=3*h[q],m+=c[r],n+=c[r+1],p+=c[r+2];b[k]=m/l;b[k+1]=
n/l;b[k+2]=p/l}}},areaNormal:function(a){for(var b=this.mesh_.normalArray_,c=a.length,d=0,e=0,g=0,k=0;k<c;++k)var f=3*a[k],d=d+b[f],e=e+b[f+1],g=g+b[f+2];a=Math.sqrt(d*d+e*e+g*g);if(0===a)return null;a=1/a;return[d*a,e*a,g*a]},areaCenter:function(a){for(var b=this.mesh_.vertexArray_,c=a.length,d=0,e=0,g=0,k=0;k<c;++k)var f=3*a[k],d=d+b[f],e=e+b[f+1],g=g+b[f+2];return[d/c,e/c,g/c]},setLineOrigin:function(a,b){this.lineOrigin_=[a,b]},updateLineNormal:function(a,b){this.lineNormal_=[this.lineOrigin_[1]-
b,-this.lineOrigin_[0]+a]},cut:function(a){var b=this.mesh_,c=a.camera_;a=this.lineOrigin_;var d=a[0],e=c.height_-a[1];a=this.lineNormal_;var g=a[0],k=-a[1];a=c.unproject(d,e,0.5);c=c.unproject(d+g,e+k,0.5);d=mat4.create();mat4.invert(d,b.matTransform_);vec3.transformMat4(a,a,d);vec3.transformMat4(c,c,d);vec3.sub(c,c,a);vec3.normalize(c,c);d=new Topology(this.states_);d.mesh_=b;e=this.fillHoles_?vec3.scaleAndAdd([0,0,0],a,c,2):a;d=d.cut(e,c,this.fillHoles_);this.fillHoles_&&this.uniformProjection(a,
c,d);b.updateBuffers();this.lineNormal_=[0,0]},uniformProjection:function(a,b,c){var d=this.mesh_,e=d.vertexArray_,g=d.vertices_,k=[],f=[];d.octree_.cullPlane(a,b,k,f);var h=d.getVerticesFromTriangles(k),l=d.getVerticesFromTriangles(f);this.states_.pushState(k,h);this.states_.pushState(f,l);f=k=0;++Vertex.tagMask_;for(var m=Vertex.tagMask_,f=h.length,k=0;k<f;++k)g[h[k]].tagFlag_=m;for(var n=[0,0,0],p=l.length,k=0;k<p;++k)f=l[k],g[f].tagFlag!==m&&(n[0]=e[3*f],n[1]=e[3*f+1],n[2]=e[3*f+2],0<vec3.dot(b,
vec3.sub(n,n,a))&&h.push(f));g=d.getTrianglesFromVertices(h);e=new Topology(this.states_);e.mesh_=d;e.planeOrigin_=a;e.planeNormal_=b;e.checkPlane_=!0;e.linearSubdivision_=!0;this.setAdaptiveParameters(e.radiusSquared_);c=Math.max(Math.min(c*(4-this.subdDetailCut_),500),10);g=e.subdivision(g,c);g=e.decimation(g,c/4.2025);e=d.vertexArray_;c=d.getVerticesFromTriangles(g);h=c.length;l=a[0];m=a[1];a=a[2];n=b[0];p=b[1];b=b[2];var q=new Float32Array(3*h);this.laplacianSmooth(c,q);for(k=0;k<h;++k){var f=
3*c[k],r=(e[f]-l)*n+(e[f+1]-m)*p+(e[f+2]-a)*b;if(!(0>r)){var f=3*k,s=q[f],u=q[f+1],v=q[f+2],r=(s-l)*n+(u-m)*p+(v-a)*b,f=3*c[k];e[f]=s-n*r;e[f+1]=u-p*r;e[f+2]=v-b*r}}d.updateMesh(g,d.getVerticesFromTriangles(g))}};var Utils={nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},tidy:function(a){a.sort(function(a,b){return a-b});for(var b=a.length,c=0,d=0,c=1;c<b;++c)a[d]!==a[c]&&(a[++d]=a[c]);1<c&&(a.length=d+1)},intersectionArrays:function(a,b){for(var c=0,d=0,e=[],g=a.length,k=b.length;c<g&&d<k;)a[c]<b[d]?c++:a[c]>b[d]?d++:(e.push(a[c]),++c,++d);return e},rotateArray:function(a,b){b=-b;var c=a.length;b=(Math.abs(b)>=c&&(b%=c),0>b&&(b+=c),b);for(var d,e;b;b=(Math.ceil(c/b)-1)*b-
c+(c=b))for(d=c;d>b;e=a[--d],a[d]=a[d-b],a[d-b]=e);return a}},Tablet={};Tablet.plugin=document.querySelector("object[type='application/x-wacomtabletplugin']");Tablet.pressure=function(){var a;Tablet.plugin&&(a=Tablet.plugin.penAPI);return a&&a.pointerType?a.pressure:1};"function"!==typeof String.prototype.endsWith&&(String.prototype.endsWith=function(a){return this.slice(-a.length)===a});
"function"!==typeof String.prototype.startsWith&&(String.prototype.startsWith=function(a){return this.slice(0,a.length)===a});function Topology(a){this.states_=a;this.mesh_=null;this.center_=[0,0,0];this.verticesMap_={};this.radiusSquared_=0;this.iTrisToDelete_=[];this.iVertsToDelete_=[];this.iVertsDecimated_=[];this.checkPlane_=this.linearSubdivision_=!1;this.planeOrigin_=[0,0,0];this.planeNormal_=[0,0,0]};Topology.prototype.subdivision=function(a,b){var c=this.mesh_.triangles_,d=0;do d=c.length,a=this.subdivide(a,b);while(d!==c.length);return a};
Topology.prototype.subdivide=function(a,b){var c=this.mesh_,d=c.vertices_,e=c.triangles_,g=d.length,k=e.length,f=[],h=[];this.verticesMap_={};this.initSplit(a,f,h,b);20<f.length&&c.expandsTriangles(f,3);this.states_.pushState(f,c.getVerticesFromTriangles(f));h.length=f.length;this.checkArrayLength(f.length);this.subdivideTriangles(f,h,b);for(var h=[],l=e.length,f=0,f=k;f<l;++f)h.push(f);c.expandsTriangles(h,1);f=h.slice(l-k);this.states_.pushState(f,c.getVerticesFromTriangles(f));a.push.apply(a,h);
for(var k=[],l=a.length,m=++Triangle.tagMask_,f=0;f<l;++f){var n=a[f],p=e[n];p.tagFlag_!==m&&(p.tagFlag_=m,k.push(n))}for(f=e.length;0<h.length;)h=this.fillTriangles(h);for(l=e.length;f<l;++f)k.push(f);e=[];h=d.length;for(f=g;f<h;++f)e.push(f);g=e.length;c.expandsVertices(e,1);this.linearSubdivision_||(f=new Sculpt,f.mesh_=c,f.smoothFlat(e.slice(g),1));for(var c=this.mesh_.vertexArray_,f=this.center_,h=f[0],l=f[1],m=f[2],n=Vertex.sculptMask_,g=e.length,q=0,f=0;f<g;++f){var p=e[f],q=3*p,r=c[q]-h,s=
c[q+1]-l,q=c[q+2]-m;d[p].sculptFlag_=r*r+s*s+q*q<this.radiusSquared_?n:n-1}return k};
Topology.prototype.checkArrayLength=function(a){var b=this.mesh_,c=b.vertexArray_,d=b.normalArray_,e=b.colorArray_,g=b.indexArray_,k=3*b.vertices_.length,b=3*b.triangles_.length,f=0,h,l=k+200*a;if(c.length<l||c.length>4*l){h=new Float32Array(2*l);for(f=0;f<k;++f)h[f]=c[f];this.mesh_.vertexArray_=h;h=new Float32Array(2*l);for(f=0;f<k;++f)h[f]=d[f];this.mesh_.normalArray_=h;h=new Float32Array(2*l);for(f=0;f<k;++f)h[f]=e[f];this.mesh_.colorArray_=h}a=b+200*a;if(g.length<a||g.length>4*a){h=new SculptGL.indexArrayType(2*
a);for(f=0;f<b;++f)h[f]=g[f];this.mesh_.indexArray_=h}};Topology.prototype.initSplit=function(a,b,c,d){for(var e=a.length,g=0;g<e;++g){switch(this.findSplit(a[g],d,!0)){case 1:c.push(1);break;case 2:c.push(2);break;case 3:c.push(3);break;default:continue}b.push(a[g])}};
Topology.prototype.findSplit=function(){var a=[0,0,0],b=[0,0,0],c=[0,0,0],d=[0,0,0];return function(e,g,k){var f=this.mesh_,h=f.vertexArray_,f=f.indexArray_;e*=3;var l=f[e+1],m=f[e+2];e=3*f[e];a[0]=h[e];a[1]=h[e+1];a[2]=h[e+2];e=3*l;b[0]=h[e];b[1]=h[e+1];b[2]=h[e+2];e=3*m;c[0]=h[e];c[1]=h[e+1];c[2]=h[e+2];if(this.checkPlane_){if(k=this.planeOrigin_,h=this.planeNormal_,0>vec3.dot(h,vec3.sub(d,a,k))&&0>vec3.dot(h,vec3.sub(d,b,k))&&0>vec3.dot(h,vec3.sub(d,c,k)))return 0}else if(!0===k&&!Geometry.triangleInsideSphere(this.center_,
this.radiusSquared_,a,b,c)&&!Geometry.pointInsideTriangle(this.center_,a,b,c))return 0;k=vec3.sqrLen(vec3.sub(d,a,b));h=vec3.sqrLen(vec3.sub(d,b,c));f=vec3.sqrLen(vec3.sub(d,a,c));return k>h&&k>f?k>g?1:0:h>f?h>g?2:0:f>g?3:0}}();
Topology.prototype.subdivideTriangles=function(a,b,c){for(var d=this.mesh_.indexArray_,e=a.length,g=0;g<e;++g){var k=3*a[g];if(1===b[g])this.halfEdgeSplit(a[g],d[k],d[k+1],d[k+2]);else if(2===b[g])this.halfEdgeSplit(a[g],d[k+1],d[k+2],d[k]);else if(3===b[g])this.halfEdgeSplit(a[g],d[k+2],d[k],d[k+1]);else{var f=this.findSplit(a[g],c);1===f?this.halfEdgeSplit(a[g],d[k],d[k+1],d[k+2]):2===f?this.halfEdgeSplit(a[g],d[k+1],d[k+2],d[k]):3===f&&this.halfEdgeSplit(a[g],d[k+2],d[k],d[k+1])}}};
Topology.prototype.halfEdgeSplit=function(){var a=[0,0];return function(b,c,d,e){var g=this.mesh_,k=g.vertices_,f=g.triangles_,h=g.vertexArray_,l=g.normalArray_,m=g.colorArray_,n=g.indexArray_,p=f[b].leaf_,g=p.iTris_,q=k[c],r=k[d],s=k[e],u=this.verticesMap_;a[0]=Math.min(c,d);a[1]=Math.max(c,d);var v=!1,w=u[a];void 0===w&&(w=k.length,v=!0,u[a]=w);s.ringVertices_.push(w);var t=3*b;n[t]=c;n[t+1]=w;n[t+2]=e;var u=f.length,x=new Triangle(u),t=3*u;n[t]=w;n[t+1]=d;n[t+2]=e;x.stateFlag_=Mesh.stateMask_;
s.tIndices_.push(u);r.replaceTriangle(b,u);x.leaf_=p;x.posInLeaf_=g.length;if(v){var y=k.length,n=new Vertex(y),t=3*c,p=h[t],s=h[t+1],v=h[t+2],C=l[t],z=l[t+1],F=l[t+2],A=m[t],D=m[t+1],E=m[t+2],t=3*d,B=h[t],G=h[t+1],O=h[t+2],I=l[t],J=l[t+1],K=l[t+2],P=m[t],Q=m[t+1],R=m[t+2],L=C+I,M=z+J,N=F+K,H=1/Math.sqrt(L*L+M*M+N*N),t=3*y;l[t]=L*H;l[t+1]=M*H;l[t+2]=N*H;m[t]=0.5*(A+P);m[t+1]=0.5*(D+Q);m[t+2]=0.5*(E+R);m=0;this.linearSubdivision_||(H=C*I+z*J+F*K,m=0,m=-1>=H?Math.PI:1<=H?0:Math.acos(H),y=p-B,A=s-G,
D=v-O,H=Math.sqrt(y*y+A*A+D*D),m=0.12*m*H,0>y*(C-I)+A*(z-J)+D*(F-K)&&(m=-m));h[t]=0.5*(p+B)+l[t]*m;h[t+1]=0.5*(s+G)+l[t+1]*m;h[t+2]=0.5*(v+O)+l[t+2]*m;n.stateFlag_=Mesh.stateMask_;n.ringVertices_.push(c,d,e);q.replaceRingVertex(d,w);r.replaceRingVertex(c,w);n.tIndices_.push(b,u);k.push(n)}else c=k[w],c.ringVertices_.push(e),c.tIndices_.push(b,u);g.push(u);f.push(x)}}();
Topology.prototype.fillTriangles=function(){var a=[0,0];return function(b){for(var c=this.mesh_,d=c.vertices_,e=c.triangles_,c=c.indexArray_,g=b.length,k=[],f=0;f<g;++f){var h=b[f],l=3*h,m=c[l],n=c[l+1],l=c[l+2],p=this.verticesMap_;m<n?(a[0]=m,a[1]=n):(a[0]=n,a[1]=m);var q=p[a];n<l?(a[0]=n,a[1]=l):(a[0]=l,a[1]=n);var r=p[a];m<l?(a[0]=m,a[1]=l):(a[0]=l,a[1]=m);var p=p[a],s=d[m].ringVertices_.length,u=d[n].ringVertices_.length,v=d[l].ringVertices_.length,w=0;q?w=r?p?s<u&&s<v?2:u<v?3:1:s<v?2:1:p&&u<
v?3:1:r?w=p&&u<s?3:2:p&&(w=3);if(1===w)this.fillTriangle(h,m,n,l,q);else if(2===w)this.fillTriangle(h,n,l,m,r);else if(3===w)this.fillTriangle(h,l,m,n,p);else continue;k.push(h,e.length-1)}return k}}();
Topology.prototype.fillTriangle=function(a,b,c,d,e){var g=this.mesh_,k=g.vertices_,f=g.triangles_,g=g.indexArray_,h=3*a;g[h]=b;g[h+1]=e;g[h+2]=d;b=f[a].leaf_;var l=b.iTris_,m=k[c],n=k[d],h=k[e];h.ringVertices_.push(d);n.ringVertices_.push(e);k=f.length;h.tIndices_.push(a,k);var p=new Triangle(k),h=3*k;g[h]=e;g[h+1]=c;g[h+2]=d;p.stateFlag_=Mesh.stateMask_;p.leaf_=b;p.posInLeaf_=l.length;n.tIndices_.push(k);m.replaceTriangle(a,k);l.push(k);f.push(p)};Topology.prototype.decimation=function(a,b){var c=0,d=this.radiusSquared_,e=Math.sqrt(d),g=this.mesh_,k=g.triangles_,f=g.vertexArray_,g=g.indexArray_;this.iVertsDecimated_=[];this.iTrisToDelete_=[];this.iVertsToDelete_=[];for(var h=this.center_,l=h[0],m=h[1],h=h[2],n=[0,0,0],p=0;p<a.length;++p){var q=a[p];if(!(0>k[q].tagFlag_)){var c=3*q,r=g[c],s=g[c+1],u=g[c+2],c=3*r,v=f[c],w=f[c+1],t=f[c+2],c=3*s,x=f[c],y=f[c+1],C=f[c+2],c=3*u,z=f[c],F=f[c+1],c=f[c+2],A=(v+x+z)/3-l,D=(w+y+F)/3-m,E=(t+C+c)/3-h,B=
A*A+D*D+E*E;if(this.checkPlane_){var B=this.planeOrigin_,G=this.planeNormal_;if(0>vec3.dot(G,vec3.sub(n,[v,w,t],B))&&0>vec3.dot(G,vec3.sub(n,[x,y,C],B))&&0>vec3.dot(G,vec3.sub(n,[z,F,c],B)))continue;B=1}else if(B<d)B=1;else if(B<2*d)B=(Math.sqrt(B)-e)/(e*Math.SQRT2-e),B=3*B*B*B*B-4*B*B*B+1;else continue;A=x-v;D=y-w;E=C-t;G=A*A+D*D+E*E;A=x-z;D=y-F;E=C-c;x=A*A+D*D+E*E;A=v-z;D=w-F;E=t-c;v=A*A+D*D+E*E;G<x&&G<v?G<b*B&&this.decimateTriangles(q,this.findOppositeTriangle(q,r,s),a):x<v?x<b*B&&this.decimateTriangles(q,
this.findOppositeTriangle(q,s,u),a):v<b*B&&this.decimateTriangles(q,this.findOppositeTriangle(q,r,u),a)}}this.applyDeletion();return this.getValidModifiedTriangles(this.getValidModifiedVertices(),a)};Topology.prototype.applyDeletion=function(a){var b=this.iTrisToDelete_;Utils.tidy(b);for(var c=0,c=b.length-1;0<=c;--c)this.deleteTriangle(b[c],a);a=this.iVertsToDelete_;Utils.tidy(a);for(c=a.length-1;0<=c;--c)this.deleteVertex(a[c])};
Topology.prototype.getValidModifiedVertices=function(){for(var a=this.mesh_.vertices_,b=this.iVertsDecimated_,c=b.length,d=a.length,e=++Vertex.tagMask_,g=[],k=0;k<c;++k){var f=b[k];if(!(f>=d)){var h=a[f];h.tagFlag_!==e&&(h.tagFlag_=e,g.push(f))}}return g};
Topology.prototype.getValidModifiedTriangles=function(a,b){var c=this.mesh_,d=c.triangles_,c=c.getTrianglesFromVertices(a);b.push.apply(b,c);for(var c=[],e=b.length,g=d.length,k=++Triangle.tagMask_,f=0;f<e;++f){var h=b[f];if(!(h>=g)){var l=d[h];l.tagFlag_!==k&&(l.tagFlag_=k,c.push(h))}}return c};
Topology.prototype.findOppositeTriangle=function(a,b,c){var d=this.mesh_.vertices_;b=d[b].tIndices_;c=d[c].tIndices_;b.sort(function(a,b){return a-b});c.sort(function(a,b){return a-b});c=Utils.intersectionArrays(b,c);return 2!==c.length?-1:c[0]===a?c[1]:c[0]};
Topology.prototype.decimateTriangles=function(a,b,c){if(-1!==b){var d=this.mesh_.indexArray_,e=3*a,g=d[e],k=d[e+1],f=d[e+2],e=3*b,h=d[e],l=d[e+1],d=d[e+2];g===h?k===d?this.edgeCollapse(a,b,g,k,f,l,c):this.edgeCollapse(a,b,g,f,k,d,c):g===l?k===h?this.edgeCollapse(a,b,g,k,f,d,c):this.edgeCollapse(a,b,g,f,k,h,c):g===d?k===l?this.edgeCollapse(a,b,g,k,f,h,c):this.edgeCollapse(a,b,g,f,k,l,c):k===h?this.edgeCollapse(a,b,f,k,g,l,c):k===l?this.edgeCollapse(a,b,f,k,g,d,c):this.edgeCollapse(a,b,f,k,g,h,c)}};
Topology.prototype.edgeCollapse=function(a,b,c,d,e,g,k){var f=this.mesh_,h=f.vertices_,l=f.triangles_,m=f.vertexArray_,n=f.normalArray_,p=f.colorArray_,q=f.indexArray_,r=h[c],s=h[d],u=r.ringVertices_,v=s.ringVertices_,w=r.tIndices_,t=s.tIndices_,x=h[e],y=h[g];if(u.length===w.length&&v.length===t.length&&x.ringVertices_.length===x.tIndices_.length&&y.ringVertices_.length===y.tIndices_.length)if(this.iVertsDecimated_.push(c,d),this.states_.pushState(w,u),this.states_.pushState(t,v),u.sort(function(a,
b){return a-b}),v.sort(function(a,b){return a-b}),h=0,3<=Utils.intersectionArrays(u,v).length)r.removeTriangle(b),s.removeTriangle(a),x.tIndices_.push(b),y.tIndices_.push(a),h=3*a,q[h]===d?q[h]=g:q[h+1]===d?q[h+1]=g:q[h+2]=g,h=3*b,q[h]===c?q[h]=e:q[h+1]===c?q[h+1]=e:q[h+2]=e,f.computeRingVertices(c),f.computeRingVertices(d),f.computeRingVertices(e),f.computeRingVertices(g),this.cleanUpSingularVertex(c),this.cleanUpSingularVertex(d),this.cleanUpSingularVertex(e),this.cleanUpSingularVertex(g);else{var h=
3*c,C=3*d;e=n[h]+n[C];g=n[h+1]+n[C+1];var z=n[h+2]+n[C+2];p[h]=0.5*(p[h]+p[C]);p[h+1]=0.5*(p[h+1]+p[C+1]);p[h+2]=0.5*(p[h+2]+p[C+2]);p=1/Math.sqrt(e*e+g*g+z*z);e*=p;g*=p;z*=p;n[h]=e;n[h+1]=g;n[h+2]=z;u.push.apply(u,v);r.removeTriangle(a);r.removeTriangle(b);s.removeTriangle(a);s.removeTriangle(b);x.removeTriangle(a);y.removeTriangle(b);w.push.apply(w,t);r=t.length;for(n=n=0;n<r;++n)v=3*t[n],q[v]===d?q[v]=c:q[v+1]===d?q[v+1]=c:q[v+2]=c;f.computeRingVertices(c);r=t=q=0;v=u.length;for(n=0;n<v;++n)x=
u[n],f.computeRingVertices(x),x*=3,q+=m[x],t+=m[x+1],r+=m[x+2];q/=v;t/=v;r/=v;f=e*(q-m[h])+g*(t-m[h+1])+z*(r-m[h+2]);m[h]=q-e*f;m[h+1]=t-g*f;m[h+2]=r-z*f;s.tagFlag_=-1;l[a].tagFlag_=-1;l[b].tagFlag_=-1;this.iVertsToDelete_.push(d);this.iTrisToDelete_.push(a,b);k.push.apply(k,w);this.cleanUpSingularVertex(c)}};
Topology.prototype.deleteTriangle=function(a,b){var c=0,d=this.mesh_,e=d.vertices_,g=d.triangles_,d=d.indexArray_;if(!b){var k=g[a],f=k.posInLeaf_,k=k.leaf_.iTris_,h=k[k.length-1];a!==h&&(k[f]=h,g[h].posInLeaf_=f);k.pop()}f=g.length-1;if(f!==a){var k=g[f],c=3*f,h=d[c],l=d[c+1],c=d[c+2];this.states_.pushState([f],[h,l,c]);k.id_=a;b||(k.leaf_.iTris_[k.posInLeaf_]=a);var m=e[l],n=e[c];e[h].replaceTriangle(f,a);m.replaceTriangle(f,a);n.replaceTriangle(f,a);this.iVertsDecimated_.push(h,l,c);g[a]=k;a*=
3;d[a]=h;d[a+1]=l;d[a+2]=c}g.pop()};
Topology.prototype.deleteVertex=function(a){var b=this.mesh_,c=b.vertices_,d=b.vertexArray_,e=b.normalArray_,g=b.colorArray_,k=b.indexArray_,b=c.length-1;if(a!==b){var f=0,h=c[b],f=3*b,l=d[f],m=d[f+1],n=d[f+2],p=e[f],q=e[f+1],r=e[f+2],s=g[f],u=g[f+1],v=g[f+2],w=this.states_;w.pushState(null,[b]);h.id_=a;for(var t=h.tIndices_,x=h.ringVertices_,y=t.length,C=x.length,z=0,z=0;z<y;++z)f=t[z],w.pushState([f],null),f*=3,k[f]===b?k[f]=a:k[f+1]===b?k[f+1]=a:k[f+2]=a;for(z=0;z<C;++z)f=x[z],k=c[f],w.pushState(null,
[f]),k.replaceRingVertex(b,a);c[a]=h;f=3*a;d[f]=l;d[f+1]=m;d[f+2]=n;e[f]=p;e[f+1]=q;e[f+2]=r;g[f]=s;g[f+1]=u;g[f+2]=v}c.pop()};Topology.prototype.adaptTopology=function(a,b){for(var c=this.mesh_,d=c.triangles_,e=c.vertexArray_,g=this.radiusSquared_,k=c.getVerticesFromTriangles(a),f=k.length,h=[],l=c.vertices_.length,m=0,n=0,m=this.center_,p=m[0],q=m[1],r=m[2],s=0,u=0,m=n=0;m<f;++m){var v=k[m];v>=l||(n=3*v,s=e[n]-p,u=e[n+1]-q,n=e[n+2]-r,s*s+u*u+n*n<g&&h.push(v))}this.checkCollisions(h,b);m=c.getTrianglesFromVertices(this.iVertsDecimated_);a.push.apply(a,m);c=[];e=a.length;g=d.length;++Triangle.tagMask_;k=Triangle.tagMask_;
for(m=0;m<e;++m)f=a[m],f>=g||(h=d[f],h.tagFlag_!==k&&(h.tagFlag_=k,c.push(f)));return c};
Topology.prototype.checkCollisions=function(a,b){var c=this.mesh_,d=c.vertices_,e=c.vertexArray_,g=0;this.iVertsDecimated_=[];this.iTrisToDelete_=[];this.iVertsToDelete_=[];var k=0.25*b,f=new Aabb,h=a.length;0<h&&(g=3*a[0],f.min_=[e[g],e[g+1],e[g+2]],f.max_=[e[g],e[g+1],e[g+2]]);for(var l=0,m=0,l=0;l<h;++l)g=3*a[l],f.expandsWithPoint(e[g],e[g+1],e[g+2]);var n=new Grid;n.setBoundaries(f);n.init(Math.sqrt(k));n.build(c,a);for(l=0;l<h;++l)if(f=a[l],g=d[f],!(0>g.tagFlag_)){var g=g.ringVertices_,p=g.length;
++Vertex.tagMask_;for(m=0;m<p;++m)d[g[m]].tagFlag_=Vertex.tagMask_;for(var g=3*f,q=e[g],r=e[g+1],s=e[g+2],u=n.getNeighborhood(q,r,s),v=u.length,m=0;m<v;++m){var w=u[m];if(f!==w){var t=d[w];if(!(0>t.tagFlag_||t.tagFlag_===Vertex.tagMask_)){var g=3*w,x=q-e[g],y=r-e[g+1],g=s-e[g+2];if(x*x+y*y+g*g<k){p>t.ringVertices_.length?this.vertexJoin(f,w):this.vertexJoin(w,f);break}}}}}this.applyDeletion();k=this.iVertsDecimated_=this.getValidModifiedVertices();h=k.length;e=[];n=Vertex.sculptMask_;for(l=0;l<h;++l)g=
k[l],d[g].sculptFlag_===n&&e.push(g);d=new Sculpt;d.mesh_=c;c.expandsVertices(e,1);d.smooth(e,1)};
Topology.prototype.vertexJoin=function(a,b){var c=this.mesh_,d=c.vertices_,e=d[a],d=d[b],g=e.tIndices_,k=d.tIndices_,f=e.ringVertices_.slice(0),h=d.ringVertices_.slice(0),l=f.length,m=h.length;this.states_.pushState(g,f);this.states_.pushState(k,h);this.states_.pushState(null,[a,b]);g=[];k=[];this.trianglesRotate(e.tIndices_,a,g);if(this.adjustEdgeOrientation(g)&&(this.trianglesRotate(d.tIndices_,b,k),this.adjustEdgeOrientation(k))){f.sort(function(a,b){return a-b});h.sort(function(a,b){return a-
b});var n=Utils.intersectionArrays(f,h);0===n.length?this.connect1Ring(g,k):this.connect1RingCommonVertices(g,k,n);for(g=g=0;g<l;++g)c.computeRingVertices(f[g]);for(g=0;g<m;++g)c.computeRingVertices(h[g]);this.iVertsDecimated_.push(a,b);this.iVertsToDelete_.push(a,b);e.tagFlag_=-1;d.tagFlag_=-1;this.cleanUpNeighborhood(f,h)}};
Topology.prototype.connect1RingCommonVertices=function(a,b,c){var d=this.mesh_,e=d.vertices_,g=d.triangles_,d=a.length,k=b.length,f=c.length,h=0;++Vertex.tagMask_;for(var l=Vertex.tagMask_,h=0;h<f;++h)e[c[h]].tagFlag_=l;for(var f=this.iTrisToDelete_,m=null,n=null,p=0,h=0;h<d;++h)m=e[a[h].v1],n=e[a[h].v2],m.tagFlag_===l&&n.tagFlag_===l&&(p=a[h].t,m.removeTriangle(p),n.removeTriangle(p),g[p].tagFlag_=-1,f.push(p));for(h=0;h<k;++h)m=e[b[h].v1],n=e[b[h].v2],m.tagFlag_===l&&n.tagFlag_===l&&(p=b[h].t,m.removeTriangle(p),
n.removeTriangle(p),g[p].tagFlag_=-1,f.push(p));g=[];f=[];g.push([]);f.push([]);this.matchEdgesCommonVertices(a,b,c[0]);for(h=0;h<d;++h)m=e[a[h].v1],n=e[a[h].v2],(m.tagFlag_!==l||n.tagFlag_!==l)&&g[g.length-1].push(a[h]),n.tagFlag_===l&&0!==g[g.length-1].length&&g.push([]);for(h=0;h<k;++h)m=e[b[h].v1],n=e[b[h].v2],(m.tagFlag_!==l||n.tagFlag_!==l)&&f[f.length-1].push(b[h]),n.tagFlag_===l&&0!==f[f.length-1].length&&f.push([]);0===g[g.length-1].length&&g.pop();0===f[f.length-1].length&&f.pop();b=g.length;
c=f.length-1;for(l=k=e=0;e<b||0<=c;)if(l=k=-1,e<b&&(k=g[e][0].v1),0<=c&&(l=f[c][f[c].length-1].v2),k===l)g[e].length>f[c].length?this.connectLinkedEdges(g[e],f[c]):this.connectLinkedEdges(f[c],g[e]),++e,--c;else for(h=0;h<d;++h)if(m=a[h].v1,m===k){this.connectLoop(g[e]);++e;break}else if(m===l){this.connectLoop(f[c]);--c;break}};
Topology.prototype.connect1Ring=function(a,b){var c=this.mesh_,d=c.vertices_,c=c.indexArray_;this.matchEdgesNearest(a,b);var e=a.length,g=b.length,k=g/e,f=0;e===g&&(f=-1);for(var h=0,l=0,h=0;h<e;++h)l=0,0!==h&&(l=Math.floor(g-k*h)),c[3*a[h].t+2]=b[l].v1,d[b[l].v1].tIndices_.push(a[h].t),l!==f&&(c[3*b[l].t+2]=a[h].v1,d[a[h].v1].tIndices_.push(b[l].t)),f=l};
Topology.prototype.connectLinkedEdges=function(a,b){var c=this.mesh_,d=c.vertices_,e=c.triangles_,c=c.indexArray_,g=a.length,k=b.length,f=b[0],h=f.t;d[f.v1].removeTriangle(h);d[f.v2].removeTriangle(h);var f=b[k-1],l=f.t;d[f.v1].removeTriangle(l);d[f.v2].removeTriangle(l);for(var f=k/g,m=0,n=0,p=0,n=0;n<g;++n)p=Math.floor(k-f*(n+1)),1>p&&(p=1),c[3*a[n].t+2]=b[p].v1,d[b[p].v1].tIndices_.push(a[n].t),p!==m&&p!==k-1&&(c[3*b[p].t+2]=a[n].v1,d[a[n].v1].tIndices_.push(b[p].t)),m=p;e[h].tagFlag_=-1;e[l].tagFlag_=
-1;this.iTrisToDelete_.push(h,l)};Topology.prototype.connectLoop=function(a){var b=this.mesh_,c=b.vertices_,d=b.indexArray_,e=a.length,g=a[0],k=g.t,f=g.v1;c[f].removeTriangle(k);c[g.v2].removeTriangle(k);c=c[f];for(g=1;g<e;++g){var h=a[g].t;d[3*h+2]=f;c.tIndices_.push(h)}b.triangles_[k].tagFlag_=-1;this.iTrisToDelete_.push(k)};
Topology.prototype.trianglesRotate=function(a,b,c){for(var d=this.mesh_.indexArray_,e=a.length,g=0,k=0,f=0,h=0,l=0;l<e;++l)g=3*a[l],k=d[g],f=d[g+1],h=d[g+2],h!==b&&(k===b?(d[g]=f,d[g+1]=h):(d[g+1]=k,d[g]=h),d[g+2]=b),c.push({v1:d[g],v2:d[g+1],t:a[l]})};
Topology.prototype.adjustEdgeOrientation=function(a){for(var b=a.length,c=0,d=-1,e=a[0].v1,g=0,k=0,g=0;g<b-1;g++){c=a[g].v2;d=-1;for(k=g+1;k<b;++k)if(a[k].v1===c)if(a[k].v2!==e)d=k;else{c=a[g+1];a[g+1]=a[k];a[k]=c;++g;g+1<b&&(e=a[g+1].v1);break}if(k===b){if(-1===d)return!1;c=a[g+1];a[g+1]=a[d];a[d]=c}}return!0};
Topology.prototype.matchEdgesCommonVertices=function(a,b,c){for(var d=a.length,e=-1,g=0,g=0;g<d;++g)if(a[g].v1===c){e=g;break}Utils.rotateArray(a,e);a=b.length;e=-1;for(g=0;g<a;++g)if(b[g].v1===c){e=g;break}Utils.rotateArray(b,e)};
Topology.prototype.matchEdgesNearest=function(a,b){for(var c=this.mesh_.vertexArray_,d=0,e=3*a[0].v1,g=c[e],k=c[e+1],f=c[e+2],e=3*b[0].v1,h=g-c[e],l=k-c[e+1],e=f-c[e+2],m=h*h+l*l+e*e,n=b.length,p=1;p<n;++p)e=3*b[p].v1,h=g-c[e],l=k-c[e+1],e=f-c[e+2],h=h*h+l*l+e*e,h<m&&(m=h,d=p);Utils.rotateArray(b,d)};Topology.prototype.cleanUpNeighborhood=function(a,b){for(var c=a.length,d=0,d=0;d<c;++d)this.cleanUpSingularVertex(a[d]);c=b.length;for(d=0;d<c;++d)this.cleanUpSingularVertex(b[d])};
Topology.prototype.cleanUpSingularVertex=function(a){var b=this.mesh_,c=b.vertices_,d=b.vertexArray_,e=b.normalArray_,g=b.colorArray_,k=b.indexArray_,f=c[a];if(!(0>f.tagFlag_)){var h=0,h=3*a,l=d[h],m=d[h+1],n=d[h+2],p=e[h],q=e[h+1],r=e[h+2],s=g[h],u=g[h+1],v=g[h+2];this.states_.pushState(f.tIndices_,f.ringVertices_);this.states_.pushState(null,[a]);if(!this.deleteVertexIfDegenerate(a)){var w=[];this.trianglesRotate(f.tIndices_,a,w);if(this.adjustEdgeOrientation(w)){for(var t=w.length,k=w[0].v1,x=
-1,d=0,d=1;d<t-1;++d)if(w[d].v2===k){x=d;break}if(-1!==x){this.checkArrayLength(1);var d=b.vertexArray_,e=b.normalArray_,g=b.colorArray_,k=b.indexArray_,t=c.length,y=new Vertex(t);y.stateFlag_=Mesh.stateMask_;h=3*t;d[h]=l;d[h+1]=m;d[h+2]=n;e[h]=-p;e[h+1]=-q;e[h+2]=-r;g[h]=s;g[h+1]=u;g[h+2]=v;for(d=0;d<=x;++d)l=w[d].t,y.tIndices_.push(l),f.removeTriangle(l),k[3*l+2]=t;c.push(y);b.computeRingVertices(a);b.computeRingVertices(t);c=y.ringVertices_;w=c.length;for(d=0;d<w;++d)b.computeRingVertices(c[d]);
f=f.ringVertices_;c=f.length;for(d=0;d<c;++d)b.computeRingVertices(f[d]);this.iVertsDecimated_.push(a,t);f=[];f.push(a,t);c=new Sculpt;c.mesh_=b;c.smooth(f,1);this.cleanUpSingularVertex(a);this.cleanUpSingularVertex(t)}}}}};
Topology.prototype.deleteVertexIfDegenerate=function(a){var b=this.mesh_,c=b.vertices_,d=b.triangles_,e=b.indexArray_,g=c[a];if(0>g.tagFlag_)return!0;Utils.tidy(g.tIndices_);var k=g.tIndices_.length,f=0,h=f=0;if(0===k)return g.tagFlag_=-1,this.iVertsToDelete_.push(a),this.iVertsDecimated_.push(a),!0;if(1===k){var k=g.tIndices_[0],f=3*k,l=[];l.push(e[f],e[f+1],e[f+2]);Utils.tidy(l);e=l.length;for(f=0;f<e;++f)h=l[f],h!==a&&(c[h].removeTriangle(k),b.computeRingVertices(h));g.tagFlag_=-1;d[k].tagFlag_=
-1;this.iTrisToDelete_.push(k);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(f=0;f<e;++f)h=l[f],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);return!0}if(2===k){k=g.tIndices_[0];f=3*k;l=[];l.push(e[f],e[f+1],e[f+2]);Utils.tidy(l);for(var m=l.length,f=0;f<m;++f)h=l[f],h!==a&&(c[h].removeTriangle(k),b.computeRingVertices(h));var n=g.tIndices_[1],f=3*n,p=[];p.push(e[f],e[f+1],e[f+2]);Utils.tidy(p);e=p.length;for(f=0;f<e;++f)h=p[f],h!==a&&(c[h].removeTriangle(n),b.computeRingVertices(h));
g.tagFlag_=-1;d[k].tagFlag_=-1;d[n].tagFlag_=-1;this.iTrisToDelete_.push(k,n);this.iVertsToDelete_.push(a);this.iVertsDecimated_.push(a);for(f=0;f<m;++f)h=l[f],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);for(f=0;f<e;++f)h=p[f],h!==a&&3>c[h].tIndices_.length&&this.deleteVertexIfDegenerate(h);return!0}return!1};Topology.prototype.cut=function(a,b,c){var d=this.mesh_,e=d.vertexArray_,g=d.vertices_,k=d.triangles_,f=0,h=[],l=[];d.octree_.cullPlane(a,b,h,l);var m=d.getVerticesFromTriangles(h),n=d.getVerticesFromTriangles(l);this.states_.pushState(h,m);this.states_.pushState(l,n);for(var p=n.length,q=a[0],r=a[1],s=a[2],u=b[0],v=b[1],w=b[2],f=0;f<p;++f){var t=n[f],x=3*t;0<u*(e[x]-q)+v*(e[x+1]-r)+w*(e[x+2]-s)&&m.push(t)}Utils.tidy(m);e=m.length;for(f=0;f<e;++f)n=g[m[f]],n.tagFlag_=-1,n.ringVertices_=[],n.tIndices_=
[];this.checkArrayLength(l.length/100);e=g.length;f=k.length;this.cleanCutTriangles(l,h,a,b);g=g.length;k=k.length;this.iVertsToDelete_=m;this.iTrisToDelete_=h;for(h=[];f<k;++f)h.push(f);d.updateTrianglesAabbAndNormal(h);h=[];for(f=e;f<g;++f)h.push(f);d.updateVerticesNormal(h);f=0;c&&(f=this.triangulateVerticesOnPlane(h,a,b));this.applyDeletion(!0);d.computeOctree(d.octree_.aabbSplit_);return f};
Topology.prototype.cleanCutTriangles=function(a,b,c,d){var e=this.mesh_,g=e.indexArray_,e=e.vertices_;this.verticesMap_={};for(var k=a.length,f=0;f<k;++f){var h=a[f],l=3*h,m=g[l],n=g[l+1],l=g[l+2],p=e[m].tagFlag_,q=e[n].tagFlag_,r=e[l].tagFlag_;0>p&&0>q&&0>r?b.push(h):0<p&&0<q&&0<r||(b.push(h),0<p?0<q?this.makeTwoTrianglesSnapOnPlane(h,m,n,l,c,d):0<r?this.makeTwoTrianglesSnapOnPlane(h,l,m,n,c,d):this.makeOneTriangleSnapOnPlane(h,m,n,l,c,d):0<q?0<r?this.makeTwoTrianglesSnapOnPlane(h,n,l,m,c,d):this.makeOneTriangleSnapOnPlane(h,
n,l,m,c,d):0<r&&this.makeOneTriangleSnapOnPlane(h,l,m,n,c,d))}};Topology.prototype.makeOneTriangleSnapOnPlane=function(a,b,c,d,e,g){var k=this.mesh_,f=k.indexArray_,h=k.vertices_,l=k.triangles_,k=h[b];k.removeTriangle(a);k.removeRingVertex(c);k.removeRingVertex(d);a=this.getProjectedVertex(b,c,e,g);d=this.getProjectedVertex(b,d,e,g);e=h[a];h=h[d];g=l.length;l.push(new Triangle(g));l=3*g;f[l]=b;f[l+1]=a;f[l+2]=d;k.tIndices_.push(g);e.tIndices_.push(g);h.tIndices_.push(g);e.ringVertices_.push(d);h.ringVertices_.push(a)};
Topology.prototype.makeTwoTrianglesSnapOnPlane=function(a,b,c,d,e,g){var k=this.mesh_,f=k.indexArray_,h=k.vertices_,k=k.triangles_,l=h[b],m=h[c];l.removeTriangle(a);l.removeRingVertex(d);m.removeTriangle(a);m.removeRingVertex(d);a=this.getProjectedVertex(c,d,e,g);d=this.getProjectedVertex(b,d,e,g);e=h[a];h=h[d];g=k.length;k.push(new Triangle(g));var n=3*g;f[n]=b;f[n+1]=c;f[n+2]=a;c=k.length;k.push(new Triangle(c));n=3*c;f[n]=b;f[n+1]=a;f[n+2]=d;l.tIndices_.push(g);m.tIndices_.push(g);e.tIndices_.push(g);
l.tIndices_.push(c);e.tIndices_.push(c);h.tIndices_.push(c);e.ringVertices_.push(d);h.ringVertices_.push(a);e.ringVertices_.push(b);l.ringVertices_.push(a)};
Topology.prototype.getProjectedVertex=function(){var a=[0,0,0],b=[0,0,0],c=[0,0,0];return function(d,e,g,k){var f=this.mesh_,h=f.vertexArray_,l=f.colorArray_,m=f.normalArray_,f=f.vertices_,n=[Math.min(d,e),Math.max(d,e)],p=this.verticesMap_[n];void 0===p&&(p=f.length,this.verticesMap_[n]=p,f.push(new Vertex(p)),n=3*d,e*=3,a[0]=h[n],a[1]=h[n+1],a[2]=h[n+2],b[0]=h[e],b[1]=h[e+1],b[2]=h[e+2],Geometry.intersectLinePlane(a,b,g,k,c),n=3*p,h[n]=c[0],h[n+1]=c[1],h[n+2]=c[2],m[n]=m[e],m[n+1]=m[e+1],m[n+2]=
m[e+2],l[n]=l[e],l[n+1]=l[e+1],l[n+2]=l[e+2],f[d].ringVertices_.push(p),f[p].ringVertices_.push(d));return p}}();
Topology.prototype.triangulateVerticesOnPlane=function(a,b,c){for(var d=this.mesh_,e=d.vertexArray_,g=d.indexArray_,k=d.vertices_,f=[],h=d=0,l=a.length,d=0;d<l;++d)for(var m=a[d],n=k[m].tIndices_,p=n.length,h=0;h<p;++h){var q=3*n[h],r=g[q],s=g[q+1],q=g[q+2],u;r===m?(u=k[q],u.tIndices_.length!==u.ringVertices_.length&&f.push([m,q])):s===m?(u=k[r],u.tIndices_.length!==u.ringVertices_.length&&f.push([m,r])):(u=k[s],u.tIndices_.length!==u.ringVertices_.length&&f.push([m,s]))}a=[];this.detectHoles(f,a);
g=1;f=0;k=a.length;for(d=0;d<k;++d){l=a[d];m=l.length;for(h=1;h<m;++h)r=3*l[h-1],s=3*l[h],n=e[r]-e[s],p=e[r+1]-e[s+1],r=e[r+2]-e[s+2],g+=n*n+p*p+r*r;f+=m-1}this.fillHoles(a,b,c);return g/f};
Topology.prototype.fillHoles=function(a,b,c){var d=this.mesh_,e=d.vertexArray_,g=d.indexArray_,k=d.vertices_,f=d.triangles_,h=0,l=0,m=b[0],n=b[1];b=b[2];var p=c[0],q=c[1],r=c[2],l=Geometry.getPerpendicularVector(c),h=[0,0,0];vec3.cross(h,l,c);c=l[0];for(var s=l[1],u=l[2],v=h[0],w=h[1],t=h[2],x=a.length,h=0;h<x;++h){var y=a[h],C=y.length,g=[];g.length=C;for(l=0;l<C;++l){var z=y[l],F=e[3*z]-m,A=e[3*z+1]-n,D=e[3*z+2]-b,F=new poly2tri.Point(c*F+s*A+u*D,v*F+w*A+t*D);F.id_=z;g[l]=F}e=new poly2tri.SweepContext(g);
e.triangulate();z=e.getTriangles();F=z.length;this.checkArrayLength(F/100);e=d.vertexArray_;g=d.indexArray_;for(l=0;l<F;++l){var D=z[l].points_,A=f.length,E=new Triangle(A),B=E.normal_;B[0]=p;B[1]=q;B[2]=r;f.push(E);E=D[0].id_;B=D[1].id_;D=D[2].id_;k[E].tIndices_.push(A);k[B].tIndices_.push(A);k[D].tIndices_.push(A);A*=3;g[A]=E;g[A+1]=D;g[A+2]=B}for(l=0;l<C;++l)d.computeRingVertices(y[l])}};
Topology.prototype.detectHoles=function(a,b){if(!(2>=a.length)){var c=a.length,d=a[0][0],e=a[0][1],g=[d,e];--c;a[0]=a[c];--a.length;for(var k=0;k<c;)if(a[k][0]===e){e=a[k][1];--c;a[k]=a[c];--a.length;if(e===d)break;g.push(e);k=0}else k++;e===d&&b.push(g);0<c&&this.detectHoles(a,b)}};function Triangle(a){this.id_=a;this.normal_=[0,0,1];this.aabb_=new Aabb;this.posInLeaf_=this.leaf_=null;this.tagFlag_=1}Triangle.tagMask_=1;Triangle.prototype={clone:function(){var a=new Triangle(this.id_);a.normal_=this.normal_.slice();a.aabb_=this.aabb_.clone();a.leaf_=this.leaf_;a.posInLeaf_=this.posInLeaf_;return a}};function State(){this.nbVerticesState_=this.nbTrianglesState_=0;this.vArState_=[];this.nArState_=[];this.cArState_=[];this.iArState_=[];this.vState_=[];this.tState_=[];this.aabbState_=new Aabb}function States(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}
States.prototype={start:function(){++Mesh.stateMask_;var a=this.undos_;this.firstState_?a.length=0:10<a.length&&(a.shift(),--this.curUndoIndex_);this.firstState_=!1;this.redos_.length=0;if(a.length)for(var b=a.length-1;b!==this.curUndoIndex_;)a.pop(),--b;a.push(new State);this.curUndoIndex_=a.length-1;a=a[this.curUndoIndex_];b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;a.aabbState_=b.octree_.aabbSplit_.clone()},pushState:function(a,b){a&&0<a.length&&this.pushStateTriangles(a);
b&&0<b.length&&this.pushStateVertices(b)},pushStateTriangles:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.iArState_,b=b.tState_,d=this.mesh_,e=d.indexArray_,d=d.triangles_,g=Mesh.stateMask_,k=a.length,f=0;f<k;++f){var h=a[f],l=d[h];l.stateFlag_!==g&&(l.stateFlag_=g,b.push(l.clone()),h*=3,c.push(e[h],e[h+1],e[h+2]))}},pushStateVertices:function(a){for(var b=this.undos_[this.curUndoIndex_],c=b.vArState_,d=b.nArState_,e=b.cArState_,b=b.vState_,g=this.mesh_,k=g.vertexArray_,f=g.normalArray_,
h=g.colorArray_,g=g.vertices_,l=Mesh.stateMask_,m=a.length,n=0;n<m;++n){var p=a[n],q=g[p];q.stateFlag_!==l&&(q.stateFlag_=l,b.push(q.clone()),p*=3,c.push(k[p],k[p+1],k[p+2]),d.push(f[p],f[p+1],f[p+2]),e.push(h[p],h[p+1],h[p+2]))}},undo:function(){if(this.undos_.length&&!this.firstState_){var a=new State,b=this.mesh_;a.nbTrianglesState_=b.triangles_.length;a.nbVerticesState_=b.vertices_.length;a.aabbState_=b.octree_.aabbSplit_.clone();this.pushRedoTriangles(a);this.pushRedoVertices(a);this.pullUndoTriangles();
this.pullUndoVertices();this.mesh_.computeOctree(this.undos_[this.curUndoIndex_].aabbState_);b.updateBuffers();this.redos_.push(a);this.curUndoIndex_?(this.firstState_=!1,--this.curUndoIndex_):this.firstState_=!0}},pushRedoTriangles:function(a){var b=this.mesh_,c=b.indexArray_,d=b.triangles_,e=d.length,b=this.undos_[this.curUndoIndex_],g=b.tState_,k=g.length,f=b.nbTrianglesState_,b=a.iArState_;a=a.tState_;var h=0,l=0;if(f<e){for(h=f;h<e;++h)a.push(d[h].clone());for(h=0;h<k;++h)l=g[h].id_,l<f&&a.push(d[l].clone());
d.length=f}else{d.length=f;for(h=0;h<k;++h)l=g[h].id_,l<e&&a.push(d[l].clone())}d=a.length;b.length=3*d;for(h=e=0;h<d;++h)l=3*a[h].id_,e=3*h,b[e]=c[l],b[e+1]=c[l+1],b[e+2]=c[l+2]},pushRedoVertices:function(a){var b=this.mesh_,c=b.vertexArray_,d=b.normalArray_,e=b.colorArray_,g=b.vertices_,k=g.length,b=this.undos_[this.curUndoIndex_],f=b.vState_,h=f.length,l=b.nbVerticesState_,b=a.vArState_,m=a.nArState_,n=a.cArState_;a=a.vState_;var p=0,q=0;if(l<k){for(p=l;p<k;++p)a.push(g[p].clone());for(p=0;p<h;++p)q=
f[p].id_,q<l&&a.push(g[q].clone());g.length=l}else{g.length=l;for(p=0;p<h;++p)q=f[p].id_,q<k&&a.push(g[q].clone())}g=a.length;b.length=3*g;m.length=3*g;n.length=3*g;for(p=k=0;p<g;++p)q=3*a[p].id_,k=3*p,b[k]=c[q],b[k+1]=c[q+1],b[k+2]=c[q+2],m[k]=d[q],m[k+1]=d[q+1],m[k+2]=d[q+2],n[k]=e[q],n[k+1]=e[q+1],n[k+2]=e[q+2]},pullUndoTriangles:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.indexArray_,b=b.triangles_,d=a.tState_,e=a.iArState_,a=a.nbTrianglesState_,g=d.length,k=0,f=0,h=
0,k=0;k<g;++k)f=d[k],f.id_<a&&(h=f.id_,b[h]=f.clone(),h*=3,f=3*k,c[h]=e[f],c[h+1]=e[f+1],c[h+2]=e[f+2])},pullUndoVertices:function(){for(var a=this.undos_[this.curUndoIndex_],b=this.mesh_,c=b.vertexArray_,d=b.normalArray_,e=b.colorArray_,b=b.vertices_,g=a.vState_,k=a.vArState_,f=a.nArState_,h=a.cArState_,a=a.nbVerticesState_,l=g.length,m=0,n=0,p=0,m=0;m<l;++m)n=g[m],n.id_<a&&(p=n.id_,b[p]=n.clone(),p*=3,n=3*m,c[p]=k[n],c[p+1]=k[n+1],c[p+2]=k[n+2],d[p]=f[n],d[p+1]=f[n+1],d[p+2]=f[n+2],e[p]=h[n],e[p+
1]=h[n+1],e[p+2]=h[n+2])},redo:function(){if(this.redos_.length){var a=this.redos_[this.redos_.length-1],b=this.mesh_;b.triangles_.length=a.nbTrianglesState_;b.vertices_.length=a.nbVerticesState_;this.pullRedoTriangles();this.pullRedoVertices();this.mesh_.computeOctree(a.aabbState_);b.updateBuffers();this.firstState_?this.firstState_=!1:this.curUndoIndex_++;this.redos_.pop()}},pullRedoTriangles:function(){for(var a=this.redos_[this.redos_.length-1],b=a.iArState_,a=a.tState_,c=a.length,d=this.mesh_,
e=d.indexArray_,d=d.triangles_,g=0,k=0,f=0,g=0;g<c;++g)k=a[g],f=k.id_,d[f]=k.clone(),f*=3,k=3*g,e[f]=b[k],e[f+1]=b[k+1],e[f+2]=b[k+2]},pullRedoVertices:function(){for(var a=this.redos_[this.redos_.length-1],b=a.vArState_,c=a.nArState_,d=a.cArState_,a=a.vState_,e=a.length,g=this.mesh_,k=g.vertexArray_,f=g.normalArray_,h=g.colorArray_,g=g.vertices_,l=0,m=0,n=0,l=0;l<e;++l)m=a[l],n=m.id_,g[n]=m.clone(),n*=3,m=3*l,k[n]=b[m],k[n+1]=b[m+1],k[n+2]=b[m+2],f[n]=c[m],f[n+1]=c[m+1],f[n+2]=c[m+2],h[n]=d[m],h[n+
1]=d[m+1],h[n+2]=d[m+2]},reset:function(){this.mesh_=null;this.undos_=[];this.redos_=[];this.curUndoIndex_=0;this.firstState_=!1}};function Vertex(a){this.id_=a;this.tIndices_=[];this.ringVertices_=[];this.stateFlag_=this.sculptFlag_=this.tagFlag_=1}Vertex.tagMask_=1;Vertex.sculptMask_=1;
Vertex.prototype={clone:function(){var a=new Vertex(this.id_);a.tIndices_=this.tIndices_.slice();a.ringVertices_=this.ringVertices_.slice();a.tagFlag_=this.tagFlag_;a.sculptFlag_=this.sculptFlag_;a.stateFlag_=this.stateFlag_;return a},replaceTriangle:function(a,b){for(var c=this.tIndices_,d=c.length,e=0;e<d;++e)if(a===c[e]){c[e]=b;break}},replaceRingVertex:function(a,b){for(var c=this.ringVertices_,d=c.length,e=0;e<d;++e)if(a===c[e]){c[e]=b;break}},removeTriangle:function(a){for(var b=this.tIndices_,
c=b.length,d=0;d<c;++d)if(a===b[d]){b[d]=b[c-1];b.pop();break}},removeRingVertex:function(a){for(var b=this.ringVertices_,c=b.length,d=0;d<c;++d)if(a===b[d]){b[d]=b[c-1];b.pop();break}}};function Gui(a){this.sculptgl_=a;this.foldTopo_=this.ctrlSubdDetailCut_=this.ctrlFillHoles_=this.ctrlCut_=this.ctrlNbTriangles_=this.ctrlNbVertices_=this.ctrlDetailDecimation_=this.ctrlDetailSubdivision_=this.ctrlIntensity_=this.ctrlRadius_=this.ctrlSculptCulling_=this.ctrlSymmetry_=this.ctrlContinuous_=this.ctrlNegative_=this.ctrlClay_=this.ctrlSculpt_=this.flatShading_=this.ctrlShaders_=this.ctrlColor_=null;this.open_=this.openFile;this.saveOBJ_=this.saveFileAsOBJ;this.savePLY_=this.saveFileAsPLY;
this.saveSTL_=this.saveFileAsSTL;this.keySketchfab_="";this.exportSketchfab_=this.exportSketchfab;this.resetBg_=this.resetBackground;this.importBg_=this.importBackground;this.resetCamera_=this.resetCamera;this.dummyFunc_=function(){}}
Gui.prototype={initGui:function(){var a=document.getElementById("gui-container"),b=new dat.GUI;this.initEditingGui(b);a.appendChild(b.domElement);this.initGeneralGui();var c=this.sculptgl_;b.domElement.addEventListener("mouseout",function(){c.focusGui_=!1},!1);b.domElement.addEventListener("mouseover",function(){c.focusGui_=!0},!1)},initGeneralGui:function(a){var b=this.sculptgl_;$("#load-file").on("click",this.open_.bind(this));$("#save-obj").on("click",this.saveOBJ_.bind(this));$("#save-ply").on("click",
this.savePLY_.bind(this));$("#save-stl").on("click",this.saveSTL_.bind(this));$("#undo").on("click",b.undo_.bind(b));$("#redo").on("click",b.redo_.bind(b));$("#resetcamera").on("click",this.resetCamera_.bind(this));$("#resetbg").on("click",this.resetBg_.bind(this));$("#importbg").on("click",this.importBg_.bind(this));$(".togglable").on("click",function(){var a=$(this).data("radio");a?($(this).siblings("li[data-radio="+a+"]").removeClass("checked"),$(this).addClass("checked"),"camera-mode"===a&&(b.camera_.mode_=
parseInt($(this).data("value"),10)),"camera-type"===a&&(b.camera_.type_=parseInt($(this).data("value"),10),b.camera_.updateProjection(),b.render())):($(this).toggleClass("checked"),"radius"===$(this).data("value")?b.usePenRadius_=!b.usePenRadius_:"intensity"===$(this).data("value")?b.usePenIntensity_=!b.usePenIntensity_:"pivot"===$(this).data("value")&&(b.camera_.toggleUsePivot(),b.camera_.usePivot_=!b.camera_.usePivot_,b.render()))});$("#about").on("click",function(){$("#about-popup").addClass("visible")});
$("#about-popup .cancel").on("click",function(){$("#about-popup").removeClass("visible")});$("#reset").on("click",b.resetSphere_.bind(b));$("#export").on("click",this.exportSketchfab_.bind(this))},initEditingGui:function(a){var b=this.sculptgl_,c=this,d=a.addFolder("Sculpt");this.ctrlSculpt_=d.add(b.sculpt_,"tool_",{"Brush (1)":Sculpt.tool.BRUSH,"Inflate (2)":Sculpt.tool.INFLATE,"Rotate (3)":Sculpt.tool.ROTATE,"Smooth (4)":Sculpt.tool.SMOOTH,"Flatten (5)":Sculpt.tool.FLATTEN,"Pinch (6)":Sculpt.tool.PINCH,
"Crease (7)":Sculpt.tool.CREASE,"Drag (8)":Sculpt.tool.DRAG,"Paint (9)":Sculpt.tool.COLOR,"Scale (0)":Sculpt.tool.SCALE,Cut:Sculpt.tool.CUT}).name("Tool");this.ctrlSculpt_.onChange(function(a){b.sculpt_.tool_=parseInt(a,10);a=b.sculpt_.tool_;var d=Sculpt.tool;c.ctrlClay_.__li.hidden=a!==d.BRUSH;c.ctrlNegative_.__li.hidden=a!==d.BRUSH&&a!==d.INFLATE&&a!==d.CREASE;c.ctrlContinuous_.__li.hidden=a===d.ROTATE||a===d.DRAG||a===d.SCALE||a===d.CUT;c.ctrlSymmetry_.__li.hidden=a===d.CUT;c.ctrlSculptCulling_.__li.hidden=
a===d.CUT;c.ctrlRadius_.__li.hidden=a===d.CUT;c.ctrlIntensity_.__li.hidden=c.ctrlContinuous_.__li.hidden;c.ctrlColor_.__li.hidden=a!==d.COLOR;c.ctrlCut_.__li.hidden=a!==d.CUT;c.ctrlFillHoles_.__li.hidden=a!==d.CUT;c.ctrlSubdDetailCut_.__li.hidden=a!==d.CUT;c.foldTopo_.__ul.hidden=a===d.CUT;a===d.CUT?($("#perspective").hide(),$("#orthographic").click()):($("#perspective").show(),b.sculpt_.lineOrigin_=[0,0],b.sculpt_.lineNormal_=[0,0])});this.ctrlClay_=d.add(b.sculpt_,"clay_").name("Clay");this.ctrlNegative_=
d.add(b.sculpt_,"negative_").name("Negative (N)");this.ctrlContinuous_=d.add(b,"continuous_").name("Continuous");this.ctrlSymmetry_=d.add(b,"symmetry_").name("Symmetry");this.ctrlSculptCulling_=d.add(b.sculpt_,"culling_").name("Sculpt culling");this.ctrlRadius_=d.add(b.picking_,"rDisplay_",5,200).name("Radius");this.ctrlIntensity_=d.add(b.sculpt_,"intensity_",0,1).name("Intensity");this.ctrlCut_=d.add(b,"cut_",0,1).name("Click to cut !");this.ctrlCut_.__li.hidden=!0;this.ctrlFillHoles_=d.add(b.sculpt_,
"fillHoles_",0,1).name("fill holes (buggy)");this.ctrlSubdDetailCut_=d.add(b.sculpt_,"subdDetailCut_",0,4).name("Detail");this.ctrlSubdDetailCut_.__li.hidden=!0;this.ctrlFillHoles_.__li.hidden=!0;d.open();this.foldTopo_=a.addFolder("Topology");this.foldTopo_.add(b.sculpt_,"topo_",{Static:Sculpt.topo.STATIC,Dynamic:Sculpt.topo.SUBDIVISION,"Adaptive (!)":Sculpt.topo.ADAPTIVE}).name("Tool").onChange(function(a){b.sculpt_.topo_=parseInt(a,10);a=b.sculpt_.topo_;var d=Sculpt.topo;c.ctrlDetailSubdivision_.__li.hidden=
a===d.STATIC;c.ctrlDetailDecimation_.__li.hidden=a!==d.SUBDIVISION});this.ctrlDetailSubdivision_=this.foldTopo_.add(b.sculpt_,"detailSubdivision_",0,1).name("Subdivision");this.ctrlDetailDecimation_=this.foldTopo_.add(b.sculpt_,"detailDecimation_",0,1).name("Decimation");this.foldTopo_.open();a=a.addFolder("Mesh");this.ctrlNbVertices_=a.add(this,"dummyFunc_").name("Ver : 0");this.ctrlNbTriangles_=a.add(this,"dummyFunc_").name("Tri : 0");d={Phong:Shader.mode.PHONG,Transparency:Shader.mode.TRANSPARENCY,
Wireframe:Shader.mode.WIREFRAME,"Normal shader":Shader.mode.NORMAL,Clay:Shader.mode.MATERIAL,Chavant:Shader.mode.MATERIAL+1,Skin:Shader.mode.MATERIAL+2,Drink:Shader.mode.MATERIAL+3,"Red velvet":Shader.mode.MATERIAL+4,Orange:Shader.mode.MATERIAL+5,Bronze:Shader.mode.MATERIAL+6};this.ctrlShaders_=a.add(new Shader,"type_",d).name("Shader");this.ctrlShaders_.onChange(function(a){b.mesh_&&(b.mesh_.initRender(parseInt(a,10),b.textures_,b.shaders_),b.render())});this.ctrlFlatShading_=a.add(new Render,"flatShading_").name("flat shading");
this.ctrlFlatShading_.onChange(function(a){b.mesh_&&(b.mesh_.render_.flatShading_=a,b.mesh_.updateBuffers(),b.render())});this.ctrlColor_=a.addColor(b.sculpt_,"color_").name("Color");this.ctrlColor_.onChange(function(a){3===a.length?b.sculpt_.color_=[a[0],a[1],a[2]]:7===a.length?(a=parseInt(a.slice(1),16),b.sculpt_.color_=[a>>16,a>>8&255,a&255]):b.sculpt_.color_=[168,66,66]});this.ctrlColor_.__li.hidden=!0;a.open()},updateMesh:function(a){a&&(a.render_.shader_.type_=this.ctrlShaders_.getValue(),this.ctrlShaders_.object=
a.render_.shader_,a.render_.flatShading_=this.ctrlFlatShading_.getValue(),this.updateMeshInfo())},updateMeshInfo:function(){var a=this.sculptgl_.mesh_;a&&(this.ctrlNbVertices_.name("Ver : "+a.vertices_.length),this.ctrlNbTriangles_.name("Tri : "+a.triangles_.length))},openFile:function(){$("#fileopen").trigger("click")},resetBackground:function(){var a=this.sculptgl_.background_;a&&(a.gl_.deleteTexture(a.backgroundLoc_),this.sculptgl_.background_=null,this.sculptgl_.render())},resetCamera:function(){this.sculptgl_.camera_.reset();
this.sculptgl_.render()},importBackground:function(){$("#backgroundopen").trigger("click")},saveFileAsOBJ:function(){if(this.sculptgl_.mesh_){var a=[Export.exportOBJ(this.sculptgl_.mesh_)],a=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.obj")}},saveFileAsPLY:function(){if(this.sculptgl_.mesh_){var a=[Export.exportPLY(this.sculptgl_.mesh_)],a=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.ply")}},saveFileAsSTL:function(){if(this.sculptgl_.mesh_){var a=[Export.exportSTL(this.sculptgl_.mesh_)],
a=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.stl")}},exportSketchfab:function(){this.sculptgl_.mesh_&&(Export.exportSketchfab(this.sculptgl_.mesh_,[58,224,224]),$(".skfb-uploader").on("keydown",function(a){a.stopPropagation()}))}};(function(){for(var a=["moz","webkit"],b=0;b<a.length&&!window.requestAnimationFrame;++b)window.requestAnimationFrame=window[a[b]+"RequestAnimationFrame"];window.requestAnimationFrame||alert("browser is too old. Probably no webgl there anyway")})();
function SculptGL(){this.gl_=null;this.mouseButton_=this.sumDisplacement_=this.lastMouseY_=this.lastMouseX_=0;this.cameraTimer_=-1;this.usePenRadius_=!0;this.continuous_=this.symmetry_=this.usePenIntensity_=!1;this.sculptTimer_=-1;this.mouseY_=this.mouseX_=this.pressureIntensity_=this.pressureRadius_=0;this.ptPlane_=[0,0,0];this.nPlane_=[1,0,0];this.states_=new States;this.camera_=new Camera;this.picking_=new Picking(this.camera_);this.pickingSym_=new Picking(this.camera_);this.sculpt_=new Sculpt(this.states_);
this.mesh_=this.background_=null;this.textures_={};this.shaders_={};this.sphere_="";this.gui_=new Gui(this);this.focusGui_=!1;this.resetSphere_=this.resetSphere;this.undo_=this.onUndo;this.redo_=this.onRedo;this.cut_=this.cut;this.queued_=!1}SculptGL.elementIndexType=0;SculptGL.indexArrayType=Uint16Array;
SculptGL.prototype={start:function(){this.initWebGL();this.loadShaders();this.gui_.initGui();this.onWindowResize();this.loadTextures();this.initEvents()},initEvents:function(){var a=this,b=$("#canvas");$("#fileopen").change(function(b){a.loadFile(b)});$("#backgroundopen").change(function(b){a.loadBackground(b)});b.mousedown(function(b){a.onMouseDown(b)});b.mouseup(function(b){a.onMouseUp(b)});b.mousewheel(function(b){a.onMouseWheel(b)});b.mousemove(function(b){a.onMouseMove(b)});b.mouseout(function(b){a.onMouseOut(b)});
b.bind("touchstart",function(b){a.onTouchStart(b)});b.bind("touchend",function(b){a.onTouchEnd(b)});b.bind("touchmove",function(b){a.onTouchMove(b)});b.bind("touchleave",function(b){a.onMouseOut(b)});b.bind("touchcancel",function(b){a.onMouseOut(b)});b[0].addEventListener("webglcontextlost",a.onContextLost,!1);b[0].addEventListener("webglcontextrestored",a.onContextRestored,!1);$(window).keydown(function(b){a.onKeyDown(b)});$(window).keyup(function(b){a.onKeyUp(b)});$(window).resize(function(b){a.onWindowResize(b)});
$(window.body).bind("touchmove",function(a){a.preventDefault()})},initWebGL:function(){var a={antialias:!1,stencil:!0,preserveDrawingBuffer:!0};try{this.gl_=$("#canvas")[0].getContext("webgl",a)||$("#canvas")[0].getContext("experimental-webgl",a)}catch(b){alert("Could not initialise WebGL.")}if(a=this.gl_)a.getExtension("OES_element_index_uint")?(SculptGL.elementIndexType=a.UNSIGNED_INT,SculptGL.indexArrayType=Uint32Array):(SculptGL.elementIndexType=a.UNSIGNED_SHORT,SculptGL.indexArrayType=Uint16Array),
a.viewportWidth=$(window).width(),a.viewportHeight=$(window).height(),a.clearColor(0.2,0.2,0.2,1),a.enable(a.DEPTH_TEST),a.depthFunc(a.LEQUAL),a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},loadTextures:function(){var a=this,b=function(b,d){var e=new Image;e.src=b;var g=a.gl_;e.onload=function(){var b=g.createTexture();g.bindTexture(g.TEXTURE_2D,b);g.texImage2D(g.TEXTURE_2D,0,g.RGBA,g.RGBA,g.UNSIGNED_BYTE,e);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MAG_FILTER,
g.LINEAR);g.texParameteri(g.TEXTURE_2D,g.TEXTURE_MIN_FILTER,g.LINEAR_MIPMAP_NEAREST);g.generateMipmap(g.TEXTURE_2D);g.bindTexture(g.TEXTURE_2D,null);a.textures_[d]=b;d===Shader.mode.MATERIAL+2&&a.loadSphere()}};b("ressources/clay.jpg",Shader.mode.MATERIAL);b("ressources/chavant.jpg",Shader.mode.MATERIAL+1);b("ressources/skin.jpg",Shader.mode.MATERIAL+2);b("ressources/drink.jpg",Shader.mode.MATERIAL+3);b("ressources/redvelvet.jpg",Shader.mode.MATERIAL+4);b("ressources/orange.jpg",Shader.mode.MATERIAL+
5);b("ressources/bronze.jpg",Shader.mode.MATERIAL+6)},loadShaders:function(){var a=function(a){var b=new XMLHttpRequest;b.open("GET",a,!1);b.send(null);return b.responseText},b=this.shaders_;b.phongVertex=a("shaders/phong.vert");b.phongFragment=a("shaders/phong.frag");b.transparencyVertex=a("shaders/transparency.vert");b.transparencyFragment=a("shaders/transparency.frag");b.wireframeVertex=a("shaders/wireframe.vert");b.wireframeFragment=a("shaders/wireframe.frag");b.normalVertex=a("shaders/normal.vert");
b.normalFragment=a("shaders/normal.frag");b.reflectionVertex=a("shaders/reflection.vert");b.reflectionFragment=a("shaders/reflection.frag");b.backgroundVertex=a("shaders/background.vert");b.backgroundFragment=a("shaders/background.frag")},loadSphere:function(){var a=new XMLHttpRequest;a.open("GET","ressources/sphere.obj",!0);var b=this;a.onload=function(){b.sphere_=this.responseText;b.resetSphere()};a.send(null)},animate:function(){var a=this.gl_;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);this.camera_.updateView();
this.background_&&(a.depthMask(!1),this.background_.render(),a.depthMask(!0));this.mesh_&&(this.mesh_.doUpdateBuffers(),this.mesh_.render(this.camera_,this.picking_,this.sculpt_.lineOrigin_,this.sculpt_.lineNormal_))},render:function(){this.queued_=!0;window.requestAnimationFrame(this.animate.bind(this))},onWindowResize:function(){var a=$(window).width(),b=$(window).height();this.camera_.width_=a;this.camera_.height_=b;$("#canvas").attr("width",a);$("#canvas").attr("height",b);var c=this.gl_;c.viewportWidth=
a;c.viewportHeight=b;c.viewport(0,0,a,b);this.camera_.updateProjection();this.render()},onKeyDown:function(a){a.stopPropagation();this.focusGui_||a.preventDefault();var b=a.which;if(a.ctrlKey&&90===b)this.onUndo();else if(a.ctrlKey&&89===b)this.onRedo();else{a.altKey&&(this.camera_.usePivot_&&this.picking_.intersectionMouseMesh(this.mesh_,this.lastMouseX_,this.lastMouseY_,0.5),this.camera_.start(this.lastMouseX_,this.lastMouseY_,this.picking_));switch(b){case 48:case 96:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.SCALE);
break;case 49:case 97:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.BRUSH);break;case 50:case 98:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.INFLATE);break;case 51:case 99:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.ROTATE);break;case 52:case 100:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.SMOOTH);break;case 53:case 101:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.FLATTEN);break;case 54:case 102:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.PINCH);break;case 55:case 103:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.CREASE);
break;case 56:case 104:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.DRAG);break;case 57:case 105:this.gui_.ctrlSculpt_.setValue(Sculpt.tool.COLOR);break;case 78:this.gui_.ctrlNegative_.setValue(!this.sculpt_.negative_);break;case 37:case 81:case 65:this.camera_.moveX_=-1;break;case 39:case 68:this.camera_.moveX_=1;break;case 38:case 90:case 87:this.camera_.moveZ_=-1;break;case 40:case 83:this.camera_.moveZ_=1}var c=this;-1===this.cameraTimer_&&(this.cameraTimer_=setInterval(function(){c.camera_.updateTranslation();
c.render()},20))}},onKeyUp:function(a){a.stopPropagation();a.preventDefault();switch(a.which){case 37:case 81:case 65:case 39:case 68:this.camera_.moveX_=0;break;case 38:case 90:case 87:case 40:case 83:this.camera_.moveZ_=0;break;case 70:this.camera_.resetViewFront();this.render();break;case 84:this.camera_.resetViewTop();this.render();break;case 76:this.camera_.resetViewLeft(),this.render()}-1!==this.cameraTimer_&&(0===this.camera_.moveX_&&0===this.camera_.moveZ_)&&(clearInterval(this.cameraTimer_),
this.cameraTimer_=-1)},onMouseDown:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX,c=a.pageY,d=this.mouseButton_=a.which,e=Tablet.pressure(),g=this.usePenRadius_?e:1,e=this.usePenIntensity_?e:1;if(1===d&&!a.altKey){if(this.mesh_)if(this.sumDisplacement_=0,this.states_.start(),this.sculpt_.tool_===Sculpt.tool.CUT)this.sculpt_.setLineOrigin(b,this.camera_.height_-c);else if(this.sculpt_.tool_===Sculpt.tool.ROTATE)this.sculpt_.startRotate(this.picking_,b,c,this.pickingSym_,this.ptPlane_,
this.nPlane_,this.symmetry_);else if(this.sculpt_.tool_===Sculpt.tool.SCALE)this.sculpt_.startScale(this.picking_,b,c,this.pickingSym_,this.ptPlane_,this.nPlane_,this.symmetry_);else if(this.continuous_&&this.sculpt_.tool_!==Sculpt.tool.DRAG){this.pressureRadius_=g;this.pressureIntensity_=e;this.mouseX_=b;this.mouseY_=c;var k=this;this.sculptTimer_=setInterval(function(){k.sculpt_.sculptStroke(k.mouseX_,k.mouseY_,k.pressureRadius_,k.pressureIntensity_,k);k.gui_.updateMeshInfo();k.render()},20)}else this.sculpt_.sculptStroke(b,
c,g,e,this)}else 3===d&&(this.camera_.usePivot_&&this.picking_.intersectionMouseMesh(this.mesh_,b,c,g),this.camera_.start(b,c,this.picking_))},onMouseUp:function(a){a.stopPropagation();a.preventDefault();this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=-1);this.gui_.updateMeshInfo();this.mouseButton_=0},onMouseOut:function(){this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=
-1);this.mouseButton_=0},onMouseWheel:function(a){a.stopPropagation();a.preventDefault();a=a.deltaY;this.camera_.zoom(0.02*(1<a?1:-1>a?-1:a));this.render()},onMouseMove:function(a){a.stopPropagation();a.preventDefault();var b=a.pageX,c=a.pageY,d=this.mouseButton_,e=this.sculpt_.tool_,g=Sculpt.tool,k=Tablet.pressure(),f=this.usePenRadius_?k:1,k=this.usePenIntensity_?k:1,h=a.altKey||a.ctrlKey||a.shiftKey;this.continuous_&&-1!==this.sculptTimer_&&!h?(this.pressureRadius_=f,this.pressureIntensity_=k,
this.mouseX_=b,this.mouseY_=c):(e!==g.CUT&&(this.mesh_&&(1!==d||e!==g.ROTATE&&e!==g.DRAG&&e!==g.SCALE))&&this.picking_.intersectionMouseMesh(this.mesh_,b,c,f),1===d&&!a.altKey?e===g.CUT?this.sculpt_.updateLineNormal(b,this.camera_.height_-c):(this.sculpt_.sculptStroke(b,c,f,k,this),this.gui_.updateMeshInfo()):3===d||a.altKey&&!a.shiftKey&&!a.ctrlKey?this.camera_.rotate(b,c):2===d||a.altKey&&a.shiftKey?this.camera_.translate((b-this.lastMouseX_)/3E3,(c-this.lastMouseY_)/3E3):a.altKey&&a.ctrlKey&&this.camera_.zoom((c-
this.lastMouseY_)/3E3),this.lastMouseX_=b,this.lastMouseY_=c,this.render())},onTouchStart:function(a){var b=a.originalEvent.targetTouches;a.stopPropagation();a.preventDefault();a=b[0].pageX;var c=b[0].pageY;this.mouseButton_=b.length;var d=Tablet.pressure(),e=this.usePenRadius_?d:1,d=this.usePenIntensity_?d:1,b=b.length;if(1===b){if(this.mesh_)if(this.sumDisplacement_=0,this.states_.start(),this.sculpt_.tool_===Sculpt.tool.CUT)this.sculpt_.setLineOrigin(a,this.camera_.height_-c);else if(this.sculpt_.tool_===
Sculpt.tool.ROTATE)this.sculpt_.startRotate(this.picking_,a,c,this.pickingSym_,this.ptPlane_,this.nPlane_,this.symmetry_);else if(this.sculpt_.tool_===Sculpt.tool.SCALE)this.sculpt_.startScale(this.picking_,a,c,this.pickingSym_,this.ptPlane_,this.nPlane_,this.symmetry_);else if(this.continuous_&&this.sculpt_.tool_!==Sculpt.tool.DRAG){this.pressureRadius_=e;this.pressureIntensity_=d;this.mouseX_=a;this.mouseY_=c;var g=this;this.sculptTimer_=setInterval(function(){g.sculpt_.sculptStroke(g.mouseX_,g.mouseY_,
g.pressureRadius_,g.pressureIntensity_,g);g.gui_.updateMeshInfo();g.render()},20)}else this.sculpt_.sculptStroke(a,c,e,d,this)}else 3===b&&(this.camera_.usePivot_&&this.picking_.intersectionMouseMesh(this.mesh_,a,c,e),this.camera_.start(a,c,this.picking_))},onTouchEnd:function(a){a.stopPropagation();a.preventDefault();this.mesh_&&this.mesh_.checkLeavesUpdate();-1!==this.sculptTimer_&&(clearInterval(this.sculptTimer_),this.sculptTimer_=-1);this.gui_.updateMeshInfo();this.mouseButton_=0},onTouchMove:function(a){var b=
a.originalEvent.targetTouches;a.stopPropagation();a.preventDefault();var c=b[0].pageX,b=b[0].pageY,d=this.mouseButton_,e=this.sculpt_.tool_,g=Sculpt.tool,k=Tablet.pressure(),f=this.usePenRadius_?k:1,k=this.usePenIntensity_?k:1,h=a.altKey||a.ctrlKey||a.shiftKey;this.continuous_&&-1!==this.sculptTimer_&&!h?(this.pressureRadius_=f,this.pressureIntensity_=k,this.mouseX_=c,this.mouseY_=b):(e!==g.CUT&&(this.mesh_&&(1!==d||e!==g.ROTATE&&e!==g.DRAG&&e!==g.SCALE))&&this.picking_.intersectionMouseMesh(this.mesh_,
c,b,f),1===d&&!a.altKey?e===g.CUT?this.sculpt_.updateLineNormal(c,this.camera_.height_-b):(this.sculpt_.sculptStroke(c,b,f,k,this),this.gui_.updateMeshInfo()):3===d||a.altKey&&!a.shiftKey&&!a.ctrlKey?this.camera_.rotate(c,b):2===d||a.altKey&&a.shiftKey?this.camera_.translate((c-this.lastMouseX_)/3E3,(b-this.lastMouseY_)/3E3):a.altKey&&a.ctrlKey&&this.camera_.zoom((b-this.lastMouseY_)/3E3),this.lastMouseX_=c,this.lastMouseY_=b,this.render())},onContextLost:function(){alert("shit happens : context lost")},
onContextRestored:function(){alert("context is restored")},loadFile:function(a){a.stopPropagation();a.preventDefault();if(0!==a.target.files.length){a=a.target.files[0];var b=a.name.toLowerCase(),c="",c=b.endsWith(".obj")?"obj":c,c=b.endsWith(".stl")?"stl":c,c=b.endsWith(".ply")?"ply":c;if(""!==c){var b=new FileReader,d=this;b.onload=function(a){d.startMeshLoad();"obj"===c?Import.importOBJ(a.target.result,d.mesh_):"stl"===c?Import.importSTL(a.target.result,d.mesh_):"ply"===c&&Import.importPLY(a.target.result,
d.mesh_);d.endMeshLoad();$("#fileopen").replaceWith($("#fileopen").clone(!0))};"obj"===c?b.readAsText(a):"stl"===c?b.readAsBinaryString(a):"ply"===c&&b.readAsBinaryString(a)}}},loadBackground:function(a){if(0!==a.target.files.length&&(a=a.target.files[0],a.type.match("image.*"))){this.background_||(this.background_=new Background(this.gl_),this.background_.init(this.shaders_));var b=new FileReader,c=this;b.onload=function(a){var b=new Image;b.src=a.target.result;c.background_.loadBackgroundTexture(b);
c.render();$("#backgroundopen").replaceWith($("#backgroundopen").clone(!0))};b.readAsDataURL(a)}},resetSphere:function(){this.startMeshLoad();Import.importOBJ(this.sphere_,this.mesh_);this.endMeshLoad()},cut:function(){this.sculpt_.cut(this.picking_);this.gui_.updateMeshInfo();this.render()},startMeshLoad:function(){this.mesh_=new Mesh(this.gl_);this.states_.reset();this.states_.mesh_=this.mesh_;this.sculpt_.mesh_=this.mesh_;Mesh.stateMask_=1;Vertex.tagMask_=1;Vertex.sculptMask_=1;Triangle.tagMask_=
1},endMeshLoad:function(){var a=this.mesh_;a.initMesh();a.moveTo([0,0,0]);this.camera_.reset();this.gui_.updateMesh(a);a.initRender(a.render_.shader_.type_,this.textures_,this.shaders_);this.render()},updateGuiMesh:function(){if(this.mesh_){var a=this.mesh_;this.ctrlColor_.object=a.render_;this.ctrlColor_.updateDisplay();this.ctrlNbVertices_.name("Vertices : "+a.vertices_.length);this.ctrlNbTriangles_.name("Triangles : "+a.triangles_.length)}},openFile:function(){$("#fileopen").trigger("click")},
saveFile:function(){if(this.mesh_){var a=[Files.exportOBJ(this.mesh_)],a=new Blob(a,{type:"text/plain;charset=utf-8"});saveAs(a,"yourMesh.obj")}},exportSketchfab:function(){this.mesh_&&(Files.exportSketchfab(this.mesh_),$(".skfb-uploader").on("keydown",function(a){a.stopPropagation()}))},onUndo:function(){this.states_.undo();this.render();this.gui_.updateMeshInfo()},onRedo:function(){this.states_.redo();this.render();this.gui_.updateMeshInfo()}};
